<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบบันทึกข้อมูลผู้ป่วยผ่าตัด - หน่วยวิสัญญี</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', 'Kanit', sans-serif;
            background: linear-gradient(135deg, #F0FDFA 0%, #CCFBF1 50%, #A7F3D0 100%);
            color: #134E4A;
            line-height: 1.6;
        }

        * {
            box-sizing: border-box;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 24px;
            padding: 20px 32px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        .main-title {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #059669 0%, #10B981 50%, #34D399 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 0;
            text-align: center;
            flex: 1;
            justify-content: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .menu-toggle {
            background: linear-gradient(135deg, #6EE7B7 0%, #34D399 100%);
            border: none;
            border-radius: 16px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(110, 231, 183, 0.3);
            color: #134E4A;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(110, 231, 183, 0.4);
            background: linear-gradient(135deg, #34D399 0%, #10B981 100%);
        }

        .menu-toggle svg {
            width: 24px;
            height: 24px;
        }

        /* Sidebar */
        .sidebar {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100vh;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(240, 253, 250, 0.95) 100%);
            backdrop-filter: blur(20px);
            box-shadow: -8px 0 32px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            border-left: 1px solid rgba(110, 231, 183, 0.2);
        }

        .sidebar.open {
            right: 0;
        }

        .sidebar-nav {
            padding: 80px 24px 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            border: none;
            background: transparent;
            border-radius: 16px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #64748B;
            transition: all 0.3s ease;
            text-align: left;
            width: 100%;
        }

        .nav-item:hover {
            background: rgba(110, 231, 183, 0.1);
            color: #059669;
            transform: translateX(-4px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, #6EE7B7 0%, #34D399 100%);
            color: #134E4A;
            box-shadow: 0 4px 12px rgba(110, 231, 183, 0.3);
        }

        .nav-item.active:hover {
            transform: translateX(-4px);
            box-shadow: 0 6px 20px rgba(110, 231, 183, 0.4);
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.show {
            opacity: 1;
            visibility: visible;
        }
.chart-container,
.card,
.dashboard-card {
    width: 100%;
    max-width: 100vw;
    min-width: 0;
    margin: 0 auto 20px auto;
    box-sizing: border-box;
}

.chart-container {
    height: 340px; /* หรือปรับตามต้องการ */
    background: #fff;
    border-radius: 18px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
    overflow: hidden;
    padding: 12px 18px;
}

/* Responsive for mobile */
@media (max-width: 768px) {
    .chart-container,
    .card,
    .dashboard-card {
        padding-left: 6px;
        padding-right: 6px;
        height: auto;
    }
    .chart-container {
        height: 220px;
        padding: 6px;
    }
}
.chart-container canvas {
    width: 100% !important;
    height: 100% !important;
    max-width: 100%;
    max-height: 100%;
    display: block;
}
        /* Cards */
        .card {
            background: linear-gradient(135deg, rgba(255, 240, 245, 0.9) 0%, rgba(240, 248, 255, 0.9) 50%, rgba(245, 255, 240, 0.9) 100%);
            border-radius: 24px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #F1F5F9;
        }

        .card-title {
            font-size: 20px;
            font-weight: 600;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 500;
            color: #475569;
            font-size: 14px;
        }

        .form-input, .form-select, .form-textarea {
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(51, 65, 85, 0.08);
            padding: 0 16px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
        }

        .form-textarea {
            min-height: 80px;
            padding: 12px 16px;
            resize: vertical;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #6EE7B7;
            box-shadow: 0 0 0 3px rgba(110, 231, 183, 0.2);
        }

        /* Buttons */
        .btn {
            padding: 14px 24px;
            border-radius: 24px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #6EE7B7;
            color: #134E4A;
        }

        .btn-primary:hover:not(:disabled) {
            background: #34D399;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #C6F6D5;
            color: #065F46;
        }

        .btn-success:hover:not(:disabled) {
            background: #A7F3D0;
        }

        .btn-secondary {
            background: #F1F5F9;
            color: #64748B;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #E2E8F0;
        }

        .btn-danger {
            background: #FED7D7;
            color: #C53030;
        }

        .btn-danger:hover:not(:disabled) {
            background: #FEB2B2;
        }

        .btn-warning {
            background: #FEF3C7;
            color: #92400E;
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            max-height: 600px;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(110, 231, 183, 0.2);
        }

        .table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 800px;
        }

        .table th {
            background: linear-gradient(135deg, #F0FDFA 0%, #CCFBF1 100%);
            padding: 18px 14px;
            text-align: left;
            font-weight: 600;
            color: #134E4A;
            border-bottom: 2px solid #6EE7B7;
            position: sticky;
            top: 0;
            z-index: 10;
            font-size: 15px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .table th:first-child {
            border-top-left-radius: 20px;
        }

        .table th:last-child {
            border-top-right-radius: 20px;
        }

        .table td {
            padding: 16px 12px;
            border-bottom: 1px solid rgba(110, 231, 183, 0.1);
            font-size: 15px;
            color: #334155;
            transition: all 0.3s ease;
        }

        .table tbody tr:nth-child(even) {
            background: linear-gradient(135deg, rgba(240, 253, 250, 0.3) 0%, rgba(204, 251, 241, 0.2) 100%);
        }

        .table tbody tr:nth-child(odd) {
            background: rgba(255, 255, 255, 0.95);
        }

        .table tbody tr:hover {
            background: linear-gradient(135deg, rgba(110, 231, 183, 0.15) 0%, rgba(52, 211, 153, 0.1) 100%) !important;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(110, 231, 183, 0.2);
        }

        .table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 20px;
        }

        .table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 20px;
        }

        /* Icons */
        .icon {
            width: 20px;
            height: 20px;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .icon-lg {
            width: 24px;
            height: 24px;
            transition: all 0.3s ease;
        }

        .icon:hover {
            transform: scale(1.1) rotate(5deg);
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));
        }

        .icon-animated {
            animation: pulse 2s infinite;
        }

        .icon-bounce {
            animation: bounce 2s infinite;
        }

        .icon-rotate {
            animation: rotate 3s linear infinite;
        }

        .icon-float {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #8B5CF6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast.success {
            background: #C6F6D5;
            color: #065F46;
        }

        .toast.error {
            background: #FED7D7;
            color: #C53030;
        }

        .toast.info {
            background: #DBEAFE;
            color: #1E40AF;
        }

        /* Form Sections */
        .form-section {
            margin-bottom: 32px;
            padding: 20px;
            background: rgba(110, 231, 183, 0.1);
            border-radius: 16px;
            border-left: 4px solid #6EE7B7;
        }

        .form-section-title {
            font-size: 16px;
            font-weight: 600;
            color: #334155;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Search and Filter */
        .search-filter {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-input {
            flex: 1;
            min-width: 200px;
        }

        /* Status badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-icu {
            background: #FED7D7;
            color: #C53030;
        }

        .status-ward {
            background: #C6F6D5;
            color: #065F46;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            margin: 20px;
            padding: 24px;
            border-radius: 24px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #F1F5F9;
        }

        .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #64748B;
            padding: 4px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .close:hover {
            background: #F1F5F9;
            color: #334155;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 16px;
                margin-left: 0 !important;
            }

            .main-title {
                font-size: 20px;
            }

            .header {
                padding: 16px 20px;
            }

            .sidebar {
                width: 280px;
                right: -280px;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .search-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .table th, .table td {
                padding: 12px 8px;
                font-size: 14px;
            }
            
            .table {
                min-width: 700px;
            }

            .btn {
                padding: 12px 20px;
                font-size: 15px;
            }

            .btn-sm {
                padding: 8px 14px;
                font-size: 13px;
            }

            .form-input, .form-select, .form-textarea {
                height: 48px;
                font-size: 16px;
            }

            .form-textarea {
                min-height: 120px;
            }

            .form-label {
                font-size: 16px;
            }

            .card-title {
                font-size: 18px;
            }

            .form-section-title {
                font-size: 16px;
            }
        }



        /* Section Visibility */
        .section {
            display: none;
        }

        .section.active {
            display: block;
        }

        /* Action buttons in table */
        .action-buttons {
            display: flex;
            gap: 4px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            border-radius: 16px;
        }

        /* Detail view styles */
        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .detail-item {
            padding: 12px;
            background: rgba(110, 231, 183, 0.1);
            border-radius: 12px;
            border-left: 3px solid #6EE7B7;
        }

        .detail-label {
            font-size: 12px;
            color: #64748B;
            font-weight: 500;
            margin-bottom: 4px;
        }

        .detail-value {
            font-size: 14px;
            color: #334155;
            font-weight: 500;
        }

        /* Pain Scale Slider */
        .pain-scale-container {
            position: relative;
            margin: 16px 0;
        }

        .pain-scale-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(to right, 
                #10B981 0%, #10B981 20%, 
                #F59E0B 20%, #F59E0B 40%, 
                #EF4444 40%, #EF4444 60%, 
                #DC2626 60%, #DC2626 80%, 
                #7C2D12 80%, #7C2D12 100%);
            outline: none;
            transition: all 0.3s ease;
        }

        .pain-scale-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 3px solid #334155;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .pain-scale-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        .pain-scale-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #FFFFFF;
            border: 3px solid #334155;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .pain-scale-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 12px;
            color: #64748B;
        }

        .pain-scale-value {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            margin-top: 8px;
            padding: 8px 16px;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .pain-value-0 { background: #DCFCE7; color: #166534; }
        .pain-value-1, .pain-value-2 { background: #FEF3C7; color: #92400E; }
        .pain-value-3, .pain-value-4 { background: #FED7AA; color: #C2410C; }
        .pain-value-5, .pain-value-6 { background: #FECACA; color: #DC2626; }
        .pain-value-7, .pain-value-8 { background: #FCA5A5; color: #B91C1C; }
        .pain-value-9, .pain-value-10 { background: #F87171; color: #7F1D1D; }

        /* Dashboard Styles */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .dashboard-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08), 
                        0 4px 16px rgba(0, 0, 0, 0.04),
                        inset 0 1px 0 rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            position: relative;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 50%);
            border-radius: 20px;
            pointer-events: none;
        }

        .dashboard-card:hover {
            transform: translateY(-6px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15), 
                        0 8px 32px rgba(0, 0, 0, 0.08),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .dashboard-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #334155;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            z-index: 1;
        }

        .metric-card {
            text-align: center;
            padding: 16px;
            border-radius: 16px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08),
                        0 2px 8px rgba(0, 0, 0, 0.04),
                        inset 0 1px 0 rgba(255, 255, 255, 0.4);
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2) 0%, transparent 50%);
            border-radius: 16px;
            pointer-events: none;
        }

        .metric-card:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12),
                        0 4px 16px rgba(0, 0, 0, 0.08),
                        inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .metric-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 4px;
            position: relative;
            z-index: 1;
        }

        .metric-label {
            font-size: 12px;
            font-weight: 500;
            opacity: 0.8;
            position: relative;
            z-index: 1;
        }

        /* Mobile-specific dashboard styles */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .dashboard-card {
                padding: 16px;
                border-radius: 16px;
                margin-bottom: 16px;
            }

            .dashboard-card-title {
                font-size: 14px;
                margin-bottom: 12px;
            }

            /* Metrics grid for mobile - 2x2 layout */
            .metrics-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }

            .metric-card {
                padding: 12px 8px;
                margin-bottom: 0;
                border-radius: 12px;
            }

            .metric-value {
                font-size: 18px;
                margin-bottom: 2px;
            }

            .metric-label {
                font-size: 10px;
                line-height: 1.2;
            }

            /* Chart containers for mobile */
            .chart-container {
                height: 250px;
                margin-top: 12px;
            }

            .chart-container-small {
                height: 200px;
                margin-top: 12px;
            }

            .chart-container-mobile {
                height: 180px;
                margin-top: 12px;
            }

            /* Special layout for trend charts */
            .trend-chart-mobile {
                height: 220px;
                margin-top: 12px;
                overflow-x: auto;
            }

            /* Stats table mobile */
            .stats-table-mobile {
                font-size: 12px;
                min-width: 100%;
                table-layout: fixed;
            }

            .stats-table-mobile th,
            .stats-table-mobile td {
                padding: 8px 6px;
                font-size: 11px;
            }

            .stats-table-mobile th:first-child,
            .stats-table-mobile td:first-child {
                width: 20%;
                word-wrap: break-word;
            }

            .stats-table-mobile th:nth-child(2),
            .stats-table-mobile td:nth-child(2) {
                width: 50%;
                word-wrap: break-word;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            .stats-table-mobile th:nth-child(3),
            .stats-table-mobile td:nth-child(3) {
                width: 15%;
                text-align: center;
            }

            .stats-table-mobile th:nth-child(4),
            .stats-table-mobile td:nth-child(4) {
                width: 15%;
                text-align: center;
            }
        }

        .metric-age-1 { background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); color: #92400E; }
        .metric-age-2 { background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%); color: #1E40AF; }
        .metric-age-3 { background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%); color: #065F46; }
        .metric-age-4 { background: linear-gradient(135deg, #FCE7F3 0%, #FBCFE8 100%); color: #BE185D; }

        .metric-service-1 { background: linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%); color: #3730A3; }
        .metric-service-2 { background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%); color: #92400E; }
        .metric-service-3 { background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); color: #065F46; }
        .metric-service-4 { background: linear-gradient(135deg, #FFF1F2 0%, #FECACA 100%); color: #991B1B; }
        .metric-service-5 { background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%); color: #6B21A8; }

        .metric-time-1 { background: linear-gradient(135deg, #ECFDF5 0%, #D1FAE5 100%); color: #065F46; }
        .metric-time-2 { background: linear-gradient(135deg, #FFF7ED 0%, #FED7AA 100%); color: #C2410C; }
        .metric-time-3 { background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%); color: #1E40AF; }
        .metric-time-4 { background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%); color: #374151; }

        .metric-icu-1 { background: linear-gradient(135deg, #FEF2F2 0%, #FECACA 100%); color: #991B1B; }
        .metric-icu-2 { background: linear-gradient(135deg, #F0FDF4 0%, #DCFCE7 100%); color: #166534; }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 16px;
        }

        .chart-container-small {
            position: relative;
            height: 250px;
            margin-top: 16px;
        }

        .stats-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-top: 16px;
            table-layout: fixed;
        }

        .stats-table th {
            background: linear-gradient(135deg, #F8FAFC 0%, #E2E8F0 100%);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #334155;
            border-bottom: 2px solid #CBD5E1;
            font-size: 14px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .stats-table th:first-child {
            border-top-left-radius: 12px;
            width: 20%;
        }

        .stats-table th:nth-child(2) {
            width: 55%;
        }

        .stats-table th:nth-child(3) {
            width: 15%;
            text-align: center;
        }

        .stats-table th:last-child {
            border-top-right-radius: 12px;
            width: 15%;
            text-align: center;
        }

        .stats-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #E2E8F0;
            font-size: 14px;
            color: #475569;
            word-wrap: break-word;
        }

        .stats-table td:first-child {
            width: 20%;
        }

        .stats-table td:nth-child(2) {
            width: 55%;
            max-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .stats-table td:nth-child(3) {
            width: 15%;
            text-align: center;
        }

        .stats-table td:last-child {
            width: 15%;
            text-align: center;
        }

        .stats-table tbody tr:nth-child(even) {
            background: rgba(248, 250, 252, 0.5);
        }

        .stats-table tbody tr:last-child td:first-child {
            border-bottom-left-radius: 12px;
        }

        .stats-table tbody tr:last-child td:last-child {
            border-bottom-right-radius: 12px;
        }

        .dashboard-filters {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            align-items: center;
            background: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 500;
            color: #64748B;
        }

        /* Success Animation */
        .success-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            text-align: center;
            backdrop-filter: blur(10px);
            display: none;
        }

        .success-animation.show {
            display: block;
            animation: successPop 0.6s ease-out;
        }

        @keyframes successPop {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.1); }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 20px;
            color: #10B981;
            animation: checkmark 0.8s ease-in-out;
        }

        @keyframes checkmark {
            0% { transform: scale(0) rotate(45deg); }
            50% { transform: scale(1.2) rotate(45deg); }
            100% { transform: scale(1) rotate(45deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="main-title">
                <svg class="icon-lg icon-bounce" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                </svg>
                ระบบบันทึกข้อมูลผู้ป่วยผ่าตัด
            </h1>
            <button class="menu-toggle" onclick="toggleSidebar()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="3" y1="6" x2="21" y2="6"/>
                    <line x1="3" y1="12" x2="21" y2="12"/>
                    <line x1="3" y1="18" x2="21" y2="18"/>
                </svg>
            </button>
        </div>

        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <button class="nav-item active" onclick="showSection('form')">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                    บันทึกข้อมูลผู้ป่วย
                </button>
                <button class="nav-item" onclick="showSection('table')">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                        <line x1="16" y1="2" x2="16" y2="6"/>
                        <line x1="8" y1="2" x2="8" y2="6"/>
                        <line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                    รายการผู้ป่วย
                </button>
                <button class="nav-item" onclick="showSection('dashboard')">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <path d="M9 9h6v6H9z"/>
                        <path d="M9 3v6"/>
                        <path d="M21 9h-6"/>
                        <path d="M9 21v-6"/>
                        <path d="M3 9h6"/>
                    </svg>
                    แดชบอร์ดสถิติ
                </button>
                <button class="nav-item" onclick="showSection('settings')">
                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
                    </svg>
                    ตั้งค่าคอลัมน์
                </button>
            </nav>
        </div>

        <!-- Sidebar Overlay -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

        <!-- Toast Notification -->
        <div id="toast" class="toast">
            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4"/>
                <circle cx="12" cy="12" r="10"/>
            </svg>
            <span id="toast-message">บันทึกข้อมูลเรียบร้อยแล้ว</span>
        </div>

        <div class="main-content">

        <!-- Form Section -->
        <div id="form" class="section active">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                        </svg>
                        บันทึกข้อมูลผู้ป่วย
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button type="button" class="btn btn-secondary" onclick="clearForm()">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18"/>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                            </svg>
                            ล้างข้อมูล
                        </button>
                        <button type="button" class="btn btn-warning" onclick="loadDataForEdit()" id="editModeBtn" style="display: none;">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            โหมดแก้ไข
                        </button>
                    </div>
                </div>

                <form id="patientForm" onsubmit="handleSubmit(event)">
                    <input type="hidden" id="editRowId" name="editRowId">
                    
                    <!-- Form fields in exact column order -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <svg class="icon icon-bounce" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            ข้อมูลผู้ป่วย
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #EF4444;">
                                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="16" y1="2" x2="16" y2="6"/>
                                        <line x1="8" y1="2" x2="8" y2="6"/>
                                        <line x1="3" y1="10" x2="21" y2="10"/>
                                    </svg>
                                    Date *
                                </label>
                                <input type="date" class="form-input" name="Date" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #8B5CF6;">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14,2 14,8 20,8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                    </svg>
                                    AN *
                                </label>
                                <input type="text" class="form-input" name="AN" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #F59E0B;">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="8.5" cy="7" r="4"/>
                                        <line x1="20" y1="8" x2="20" y2="14"/>
                                        <line x1="23" y1="11" x2="17" y2="11"/>
                                    </svg>
                                    HN *
                                </label>
                                <input type="text" class="form-input" name="HN" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #06B6D4;">
                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                        <polyline points="9,22 9,12 15,12 15,22"/>
                                    </svg>
                                    Pre ward
                                </label>
                                <select class="form-select" name="Pre ward">
                                    <option value="">เลือกหอผู้ป่วย</option>
                                    <option value="หอผู้ป่วยใน 1">หอผู้ป่วยใน 1</option>
                                    <option value="หอผู้ป่วยใน 2">หอผู้ป่วยใน 2</option>
                                    <option value="หอผู้ป่วยใน 3">หอผู้ป่วยใน 3</option>
                                    <option value="ICU">ICU</option>
                                    <option value="ER">ER</option>
                                    <option value="OPD">OPD</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #10B981;">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                        <circle cx="12" cy="7" r="4"/>
                                        <path d="M12 14v7"/>
                                        <path d="M8 18h8"/>
                                    </svg>
                                    Age gr.
                                </label>
                                <select class="form-select" name="Age gr.">
                                    <option value="">เลือกกลุ่มอายุ</option>
                                    <option value="เด็ก">เด็ก (0-15 ปี)</option>
                                    <option value="ผู้ใหญ่">ผู้ใหญ่ (16-64 ปี)</option>
                                    <option value="ผู้สูงอายุ">ผู้สูงอายุ (65+ ปี)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #EC4899;">
                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                        <circle cx="12" cy="7" r="4"/>
                                    </svg>
                                    Sex
                                </label>
                                <select class="form-select" name="Sex">
                                    <option value="">เลือกเพศ</option>
                                    <option value="ชาย">ชาย</option>
                                    <option value="หญิง">หญิง</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Anesthesia Section -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <svg class="icon icon-float" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                <circle cx="12" cy="12" r="2"/>
                            </svg>
                            การวิสัญญีและการผ่าตัด
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #3B82F6;">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                        <circle cx="12" cy="12" r="2"/>
                                    </svg>
                                    AN type
                                </label>
                                <select class="form-select" name="AN type">
                                    <option value="">เลือกประเภท</option>
                                    <option value="General">General Anesthesia</option>
                                    <option value="Spinal">Spinal Anesthesia</option>
                                    <option value="Epidural">Epidural</option>
                                    <option value="Local">Local Anesthesia</option>
                                    <option value="Sedation">Sedation</option>
                                    <option value="Combined">Combined</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #6366F1;">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                        <path d="M12 2v20"/>
                                    </svg>
                                    AN type 2
                                </label>
                                <select class="form-select" name="AN type 2">
                                    <option value="">เลือกประเภท</option>
                                    <option value="General">General Anesthesia</option>
                                    <option value="Spinal">Spinal Anesthesia</option>
                                    <option value="Epidural">Epidural</option>
                                    <option value="Local">Local Anesthesia</option>
                                    <option value="Sedation">Sedation</option>
                                    <option value="Combined">Combined</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #059669;">
                                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="9" cy="7" r="4"/>
                                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                    </svg>
                                    Service
                                </label>
                                <input type="text" class="form-input" name="Service">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #DC2626;">
                                        <path d="M9 11H1l2-2 2 2"/>
                                        <path d="M23 11h-8l2-2 2 2"/>
                                        <path d="M12 2v20"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    Dx.
                                </label>
                                <input type="text" class="form-input" name="Dx.">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #7C3AED;">
                                        <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                                    </svg>
                                    Operation
                                </label>
                                <input type="text" class="form-input" name="Operation">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #EA580C;">
                                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                        <polyline points="9,22 9,12 15,12 15,22"/>
                                        <path d="M12 2v7"/>
                                        <path d="M8 9h8"/>
                                    </svg>
                                    Plan ICU
                                </label>
                                <input type="text" class="form-input" name="Plan ICU">
                            </div>
                        </div>
                    </div>

                    <!-- Assessment Section -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <svg class="icon icon-pulse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 11H1l2-2 2 2"/>
                                <path d="M23 11h-8l2-2 2 2"/>
                                <path d="M12 2v20"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            การประเมินและความเสี่ยง
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #0EA5E9;">
                                        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                        <circle cx="8.5" cy="7" r="4"/>
                                        <line x1="20" y1="8" x2="20" y2="14"/>
                                        <line x1="23" y1="11" x2="17" y2="11"/>
                                    </svg>
                                    การเยี่ยมผู้ป่วย
                                </label>
                                <input type="text" class="form-input" name="การเยี่ยมผู้ป่วย">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #F97316;">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    Aware 1
                                </label>
                                <input type="text" class="form-input" name="Aware 1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #EAB308;">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M21 17v2a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-2"/>
                                    </svg>
                                    Aware 2
                                </label>
                                <input type="text" class="form-input" name="Aware 2">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #84CC16;">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M3 21v-6"/>
                                        <path d="M21 21v-6"/>
                                    </svg>
                                    Aware 3
                                </label>
                                <input type="text" class="form-input" name="Aware 3">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #06B6D4;">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14,2 14,8 20,8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                    </svg>
                                    IC
                                </label>
                                <input type="text" class="form-input" name="IC">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #EF4444;">
                                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                                    </svg>
                                    CVS
                                </label>
                                <input type="text" class="form-input" name="CVS">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #8B5CF6;">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                    Endo
                                </label>
                                <input type="text" class="form-input" name="Endo">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #14B8A6;">
                                        <path d="M9 12l2 2 4-4"/>
                                        <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3"/>
                                        <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3"/>
                                        <path d="M3 12h6m6 0h6"/>
                                    </svg>
                                    RS
                                </label>
                                <input type="text" class="form-input" name="RS">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #DC2626;">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                        <line x1="9" y1="9" x2="9.01" y2="9"/>
                                        <line x1="15" y1="9" x2="15.01" y2="9"/>
                                    </svg>
                                    Hemato
                                </label>
                                <input type="text" class="form-input" name="Hemato">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #64748B;">
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
                                    </svg>
                                    Other
                                </label>
                                <input type="text" class="form-input" name="Other">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #F59E0B;">
                                        <path d="M9 11H1l2-2 2 2"/>
                                        <path d="M23 11h-8l2-2 2 2"/>
                                        <path d="M12 2v20"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    Stroke Risk
                                </label>
                                <input type="text" class="form-input" name="Stroke Risk">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #EF4444;">
                                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                                        <path d="M12 5L8 21l4-7 4 7-4-16"/>
                                    </svg>
                                    Cardiac Risk
                                </label>
                                <input type="text" class="form-input" name="Cardiac Risk">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #7C3AED;">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    Malampati
                                </label>
                                <select class="form-select" name="Malampati">
                                    <option value="">เลือก Score</option>
                                    <option value="I">Class I</option>
                                    <option value="II">Class II</option>
                                    <option value="III">Class III</option>
                                    <option value="IV">Class IV</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #059669;">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14,2 14,8 20,8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                    </svg>
                                    IIG
                                </label>
                                <input type="text" class="form-input" name="IIG">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #0891B2;">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                        <polyline points="7.5,4.21 12,6.81 16.5,4.21"/>
                                        <polyline points="7.5,19.79 7.5,14.6 3,12"/>
                                        <polyline points="21,12 16.5,14.6 16.5,19.79"/>
                                        <polyline points="3.27,6.96 12,12.01 20.73,6.96"/>
                                        <line x1="12" y1="22.08" x2="12" y2="12"/>
                                    </svg>
                                    MH distance
                                </label>
                                <input type="number" class="form-input" name="MH distance">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #C2410C;">
                                        <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
                                        <circle cx="12" cy="12" r="4"/>
                                    </svg>
                                    MT distance
                                </label>
                                <input type="number" class="form-input" name="MT distance">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #9333EA;">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        <path d="M12 6v6l4 2"/>
                                    </svg>
                                    MSD
                                </label>
                                <input type="text" class="form-input" name="MSD">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #16A34A;">
                                        <path d="M1 4v6h6"/>
                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                                        <path d="M12 6v6l4 2"/>
                                    </svg>
                                    AOJ extention
                                </label>
                                <input type="text" class="form-input" name="AOJ extention">
                            </div>
                        </div>
                    </div>

                    <!-- Pre-operative Section -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <svg class="icon icon-bounce" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12,6 12,12 16,14"/>
                            </svg>
                            ก่อนผ่าตัด
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #DC2626;">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        <path d="M8 12h8"/>
                                        <path d="M12 8v8"/>
                                    </svg>
                                    ASA status
                                </label>
                                <select class="form-select" name="ASA status">
                                    <option value="">เลือก ASA</option>
                                    <option value="I">ASA I</option>
                                    <option value="II">ASA II</option>
                                    <option value="III">ASA III</option>
                                    <option value="IV">ASA IV</option>
                                    <option value="V">ASA V</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #0891B2;">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12,6 12,12 16,14"/>
                                        <path d="M8 2v4"/>
                                        <path d="M16 2v4"/>
                                    </svg>
                                    NPO
                                </label>
                                <input type="number" class="form-input" name="NPO">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #059669;">
                                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                        <polyline points="14,2 14,8 20,8"/>
                                        <line x1="16" y1="13" x2="8" y2="13"/>
                                        <line x1="16" y1="17" x2="8" y2="17"/>
                                        <polyline points="10,9 9,9 9,10"/>
                                    </svg>
                                    รอดมยา
                                </label>
                                <input type="text" class="form-input" name="รอดมยา">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #7C3AED;">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6"/>
                                        <path d="M12 17v6"/>
                                    </svg>
                                    Aldrette score แรกรับ
                                </label>
                                <input type="number" class="form-input" name="Aldrette score แรกรับ">
                            </div>
                        </div>
                    </div>

                    <!-- Anesthesia Management -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <svg class="icon icon-rotate" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                            </svg>
                            การจัดการวิสัญญี
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #3B82F6;">
                                        <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                        <circle cx="12" cy="12" r="2"/>
                                        <path d="M12 2v20"/>
                                    </svg>
                                    Anesthesia
                                </label>
                                <input type="text" class="form-input" name="Anesthesia">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #059669;">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                        <line x1="9" y1="9" x2="9.01" y2="9"/>
                                        <line x1="15" y1="9" x2="15.01" y2="9"/>
                                        <path d="M12 2v4"/>
                                    </svg>
                                    Tube
                                </label>
                                <input type="text" class="form-input" name="Tube">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #DC2626;">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                        <path d="M12 1v6"/>
                                        <path d="M12 17v6"/>
                                    </svg>
                                    LV
                                </label>
                                <input type="text" class="form-input" name="LV">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #F59E0B;">
                                        <path d="M1 4v6h6"/>
                                        <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                    Attempt
                                </label>
                                <input type="number" class="form-input" name="Attempt">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #8B5CF6;">
                                        <circle cx="12" cy="12" r="10"/>
                                        <polyline points="12,6 12,12 16,14"/>
                                    </svg>
                                    AN time
                                </label>
                                <input type="number" class="form-input" name="AN time">
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #10B981;">
                                        <polygon points="13,2 3,14 12,14 11,22 21,10 12,10 13,2"/>
                                    </svg>
                                    Start-go
                                </label>
                                <input type="number" class="form-input" name="Start-go">
                            </div>
                        </div>
                    </div>

                    <!-- Intraoperative Section -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <svg class="icon icon-float" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                <path d="M12 2v20"/>
                            </svg>
                            ระหว่างผ่าตัด
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">Intra comp</label>
                                <input type="text" class="form-input" name="Intra comp">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pre Hct</label>
                                <input type="number" class="form-input" name="Pre Hct">
                            </div>
                            <div class="form-group">
                                <label class="form-label">G/M blood</label>
                                <input type="number" class="form-input" name="G/M blood">
                            </div>
                            <div class="form-group">
                                <label class="form-label">G/M FFP</label>
                                <input type="number" class="form-input" name="G/M FFP">
                            </div>
                            <div class="form-group">
                                <label class="form-label">G/M Plt Conc</label>
                                <input type="number" class="form-input" name="G/M Plt Conc">
                            </div>
                            <div class="form-group">
                                <label class="form-label">OR G/M</label>
                                <input type="number" class="form-input" name="OR G/M">
                            </div>
                            <div class="form-group">
                                <label class="form-label">PRC/LPRC</label>
                                <input type="number" class="form-input" name="PRC/LPRC">
                            </div>
                            <div class="form-group">
                                <label class="form-label">FFP</label>
                                <input type="number" class="form-input" name="FFP">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Plt Conc</label>
                                <input type="number" class="form-input" name="Plt Conc">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Intra EBL</label>
                                <input type="number" class="form-input" name="Intra EBL">
                            </div>
                        </div>
                    </div>

                    <!-- Recovery Room Section -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <svg class="icon icon-bounce" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9,22 9,12 15,12 15,22"/>
                                <path d="M9 10v1M15 10v1"/>
                            </svg>
                            ห้องฟื้น
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">RR comp 1</label>
                                <input type="text" class="form-input" name="RR comp 1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">RR comp 2</label>
                                <input type="text" class="form-input" name="RR comp 2">
                            </div>
                            <div class="form-group">
                                <label class="form-label">RR EBL</label>
                                <input type="number" class="form-input" name="RR EBL">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Aldrette scoreก่อนกลับตึก</label>
                                <input type="number" class="form-input" name="Aldrette scoreก่อนกลับตึก">
                            </div>
                            <div class="form-group">
                                <label class="form-label">RR time</label>
                                <input type="number" class="form-input" name="RR time">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Ward comp 1</label>
                                <input type="text" class="form-input" name="Ward comp 1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Post ward</label>
                                <input type="text" class="form-input" name="Post ward">
                            </div>
                        </div>
                    </div>

                    <!-- Pain Management Section -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <svg class="icon icon-pulse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                            </svg>
                            การจัดการความเจ็บปวด
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #EF4444;">
                                        <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                                    </svg>
                                    Pre op pain
                                </label>
                                <div class="pain-scale-container">
                                    <input type="range" class="pain-scale-slider" name="Pre op pain" min="1" max="10" value="1" oninput="updatePainValue(this, 'preOpValue')">
                                    <div class="pain-scale-labels">
                                        <span>1</span>
                                        <span>2</span>
                                        <span>3</span>
                                        <span>4</span>
                                        <span>5</span>
                                        <span>6</span>
                                        <span>7</span>
                                        <span>8</span>
                                        <span>9</span>
                                        <span>10</span>
                                    </div>
                                    <div id="preOpValue" class="pain-scale-value pain-value-1">1 - เจ็บน้อยที่สุด</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #DC2626;">
                                        <circle cx="12" cy="12" r="10"/>
                                        <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                        <line x1="9" y1="9" x2="9.01" y2="9"/>
                                        <line x1="15" y1="9" x2="15.01" y2="9"/>
                                    </svg>
                                    pain สูงสุด
                                </label>
                                <div class="pain-scale-container">
                                    <input type="range" class="pain-scale-slider" name="pain สูงสุด" min="1" max="10" value="1" oninput="updatePainValue(this, 'maxPainValue')">
                                    <div class="pain-scale-labels">
                                        <span>1</span>
                                        <span>2</span>
                                        <span>3</span>
                                        <span>4</span>
                                        <span>5</span>
                                        <span>6</span>
                                        <span>7</span>
                                        <span>8</span>
                                        <span>9</span>
                                        <span>10</span>
                                    </div>
                                    <div id="maxPainValue" class="pain-scale-value pain-value-1">1 - เจ็บน้อยที่สุด</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #F59E0B;">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                    </svg>
                                    Last pain
                                </label>
                                <div class="pain-scale-container">
                                    <input type="range" class="pain-scale-slider" name="Last pain" min="1" max="10" value="1" oninput="updatePainValue(this, 'lastPainValue')">
                                    <div class="pain-scale-labels">
                                        <span>1</span>
                                        <span>2</span>
                                        <span>3</span>
                                        <span>4</span>
                                        <span>5</span>
                                        <span>6</span>
                                        <span>7</span>
                                        <span>8</span>
                                        <span>9</span>
                                        <span>10</span>
                                    </div>
                                    <div id="lastPainValue" class="pain-scale-value pain-value-1">1 - เจ็บน้อยที่สุด</div>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Narcotic</label>
                                <input type="text" class="form-input" name="Narcotic">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Total narcotic (ครั้ง)</label>
                                <input type="number" class="form-input" name="Total narcotic (ครั้ง)">
                            </div>
                            <div class="form-group">
                                <label class="form-label">NSAIDS</label>
                                <input type="text" class="form-input" name="NSAIDS">
                            </div>
                            <div class="form-group">
                                <label class="form-label">PO pain Rx.</label>
                                <input type="text" class="form-input" name="PO pain Rx.">
                            </div>
                        </div>
                    </div>

                    <!-- Staff and Visit Section -->
                    <div class="form-section">
                        <div class="form-section-title">
                            <svg class="icon icon-float" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            ทีมแพทย์และการเยี่ยม
                        </div>
                        <div class="form-grid">
                            <div class="form-group">
                                <label class="form-label">PO guideline</label>
                                <input type="text" class="form-input" name="PO guideline">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Pre an visit</label>
                                <input type="text" class="form-input" name="Pre an visit">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Anesthetist 1</label>
                                <input type="text" class="form-input" name="Anesthetist 1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Anesthetist 2</label>
                                <input type="text" class="form-input" name="Anesthetist 2">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Anesthetist 3</label>
                                <input type="text" class="form-input" name="Anesthetist 3">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Anesthetist 4</label>
                                <input type="text" class="form-input" name="Anesthetist 4">
                            </div>
                            <div class="form-group">
                                <label class="form-label">RR nurse 1</label>
                                <input type="text" class="form-input" name="RR nurse 1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">RR nurse 2</label>
                                <input type="text" class="form-input" name="RR nurse 2">
                            </div>
                            <div class="form-group">
                                <label class="form-label">RR nurse 3</label>
                                <input type="text" class="form-input" name="RR nurse 3">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Post an visit</label>
                                <input type="text" class="form-input" name="Post an visit">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Surgeon 1</label>
                                <input type="text" class="form-input" name="Surgeon 1">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Surgeon 2</label>
                                <input type="text" class="form-input" name="Surgeon 2">
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 32px;">
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                <polyline points="17,21 17,13 7,13 7,21"/>
                                <polyline points="7,3 7,8 15,8"/>
                            </svg>
                            <span id="submitText">บันทึกข้อมูล</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Table Section -->
        <div id="table" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 6h18"/>
                            <path d="M3 12h18"/>
                            <path d="M3 18h18"/>
                        </svg>
                        รายการผู้ป่วย
                    </div>
                    <button class="btn btn-success" onclick="loadPatientData()">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 4v6h6"/>
                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                        </svg>
                        รีเฟรช
                    </button>
                </div>

                <div class="search-filter">
                    <input type="text" class="form-input search-input" id="searchInput" placeholder="ค้นหา AN, HN, หรือชื่อแพทย์..." onkeyup="filterTable()">
                    <select class="form-select" id="wardFilter" onchange="filterTable()">
                        <option value="">ทุกหอผู้ป่วย</option>
                    </select>
                    <select class="form-select" id="monthFilter" onchange="filterTable()">
                        <option value="">เลือกเดือน</option>
                    </select>
                    <select class="form-select" id="yearFilter" onchange="filterTable()">
                        <option value="">เลือกปี</option>
                    </select>
                    <input type="date" class="form-input" id="dateFilter" onchange="filterTable()">
                </div>

                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>วันที่</th>
                                <th>AN</th>
                                <th>HN</th>
                                <th>อายุ</th>
                                <th>เพศ</th>
                                <th>การผ่าตัด</th>
                                <th>แพทย์</th>
                                <th>การจัดการ</th>
                            </tr>
                        </thead>
                        <tbody id="patientTableBody">
                            <tr>
                                <td colspan="8" style="text-align: center; padding: 40px;">
                                    <div class="spinner" style="margin: 0 auto 16px;"></div>
                                    กำลังโหลดข้อมูล...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <svg class="icon-lg icon-animated" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                            <path d="M9 9h6v6H9z"/>
                            <path d="M9 3v6"/>
                            <path d="M21 9h-6"/>
                            <path d="M9 21v-6"/>
                            <path d="M3 9h6"/>
                        </svg>
                        แดชบอร์ดสถิติผู้ป่วย
                    </div>
                    <button class="btn btn-success" onclick="loadDashboardData()">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 4v6h6"/>
                            <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/>
                        </svg>
                        รีเฟรช
                    </button>
                </div>

                <!-- Dashboard Filters -->
                <div class="dashboard-filters">
                    <div class="filter-group">
                        <label class="filter-label">ค้นหา</label>
                        <input type="text" class="form-input" id="dashboardSearchInput" placeholder="ค้นหา HN, AN, IPD, Surgeon..." onkeyup="filterDashboardData()">
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">เดือน</label>
                        <select class="form-select" id="dashboardMonthFilter" onchange="filterDashboardData()">
                            <option value="">ทุกเดือน</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">ปี</label>
                        <select class="form-select" id="dashboardYearFilter" onchange="filterDashboardData()">
                            <option value="">ทุกปี</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label class="filter-label">แพทย์</label>
                        <select class="form-select" id="dashboardSurgeonFilter" onchange="filterDashboardData()">
                            <option value="">ทุกแพทย์</option>
                        </select>
                    </div>
                </div>

                <!-- Charts and Metrics Grid -->
                <div class="dashboard-grid">
                    <!-- Patient Trend Chart -->
                    <div class="dashboard-card" style="grid-column: span 2;">
                        <div class="dashboard-card-title">
                            <svg class="icon icon-bounce" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #45B7D1;">
                                <path d="M3 3v18h18"/>
                                <path d="M18.7 8l-5.1 5.2-2.8-2.7L7 14.3"/>
                                <circle cx="7" cy="14" r="2" fill="#96CEB4"/>
                                <circle cx="11" cy="11" r="2" fill="#FFEAA7"/>
                                <circle cx="14" cy="8" r="2" fill="#DDA0DD"/>
                            </svg>
                            แนวโน้มผู้ป่วยรายวัน (แยกตามแพทย์)
                        </div>
                        <div class="chart-container trend-chart-mobile">
                            <canvas id="patientTrendChart"></canvas>
                        </div>
                    </div>

                    <!-- Gender Distribution -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <svg class="icon icon-pulse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #FF6B6B;">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                                <line x1="9" y1="9" x2="9.01" y2="9"/>
                                <line x1="15" y1="9" x2="15.01" y2="9"/>
                                <path d="M12 2v4" stroke="#4ECDC4" stroke-width="3"/>
                                <path d="M12 18v4" stroke="#96CEB4" stroke-width="3"/>
                            </svg>
                            สถิติเพศ
                        </div>
                        <div class="chart-container-small chart-container-mobile">
                            <canvas id="genderChart"></canvas>
                        </div>
                    </div>

                    <!-- AN Type Distribution -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <svg class="icon icon-float" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #BB8FCE;">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"/>
                                <circle cx="12" cy="12" r="3" fill="#F7DC6F"/>
                                <path d="M12 2l2 4-2 4-2-4z" fill="#98D8C8"/>
                            </svg>
                            สถิติประเภทการวิสัญญี
                        </div>
                        <div class="chart-container-small chart-container-mobile">
                            <canvas id="anTypeChart"></canvas>
                        </div>
                    </div>

                    <!-- Pre Ward Distribution - Full width on mobile -->
                    <div class="dashboard-card" style="grid-column: span 2;">
                        <div class="dashboard-card-title">
                            <svg class="icon icon-bounce" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #82E0AA;">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                                <polyline points="9,22 9,12 15,12 15,22"/>
                                <circle cx="12" cy="15" r="2" fill="#F8C471"/>
                                <rect x="10" y="6" width="4" height="2" fill="#85C1E9"/>
                            </svg>
                            สถิติหอผู้ป่วย
                        </div>
                        <div class="chart-container chart-container-mobile">
                            <canvas id="preWardChart"></canvas>
                        </div>
                    </div>

                    <!-- Age Group Metrics -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <svg class="icon icon-rotate" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #FFEAA7;">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4" fill="#DDA0DD"/>
                                <path d="M12 2v2" stroke="#4ECDC4" stroke-width="3"/>
                                <path d="M12 11v2" stroke="#96CEB4" stroke-width="3"/>
                            </svg>
                            สถิติกลุ่มอายุ
                        </div>
                        <div id="ageGroupMetrics" class="metrics-grid">
                            <!-- Age group metrics will be populated here -->
                        </div>
                    </div>

                    <!-- Service Type Metrics -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <svg class="icon icon-pulse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #4ECDC4;">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4" fill="#F7DC6F"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                                <circle cx="20" cy="8" r="2" fill="#98D8C8"/>
                            </svg>
                            สถิติประเภทบริการ
                        </div>
                        <div id="serviceTypeMetrics" class="metrics-grid">
                            <!-- Service type metrics will be populated here -->
                        </div>
                    </div>

                    <!-- Time Period Metrics -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <svg class="icon icon-bounce" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #F1948A;">
                                <circle cx="12" cy="12" r="10"/>
                                <polyline points="12,6 12,12 16,14"/>
                                <circle cx="12" cy="12" r="2" fill="#85C1E9"/>
                                <path d="M12 2v2" stroke="#A9DFBF" stroke-width="4"/>
                                <path d="M12 20v2" stroke="#F9E79F" stroke-width="4"/>
                            </svg>
                            สถิติเวลาราชการ
                        </div>
                        <div id="timePeriodMetrics" class="metrics-grid">
                            <!-- Time period metrics will be populated here -->
                        </div>
                    </div>

                    <!-- ICU Plan Metrics -->
                    <div class="dashboard-card">
                        <div class="dashboard-card-title">
                            <svg class="icon icon-float" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #D7BDE2;">
                                <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.29 1.51 4.04 3 5.5l7 7Z"/>
                                <circle cx="12" cy="12" r="3" fill="#AED6F1"/>
                                <path d="M12 8v8" stroke="#A3E4D7" stroke-width="2"/>
                                <path d="M8 12h8" stroke="#F8C471" stroke-width="2"/>
                            </svg>
                            สถิติแผน ICU
                        </div>
                        <div id="icuPlanMetrics" class="metrics-grid">
                            <!-- ICU plan metrics will be populated here -->
                        </div>
                    </div>

                    <!-- Operation Trend Chart -->
                    <div class="dashboard-card" style="grid-column: span 2;">
                        <div class="dashboard-card-title">
                            <svg class="icon icon-animated" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #FF6B6B;">
                                <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/>
                                <circle cx="12" cy="12" r="2" fill="currentColor"/>
                                <path d="M3 3l18 18" stroke="#4ECDC4" stroke-width="1"/>
                            </svg>
                            แนวโน้มการผ่าตัด (แยกตามประเภท)
                        </div>
                        <div class="chart-container trend-chart-mobile">
                            <canvas id="operationTrendChart"></canvas>
                        </div>
                    </div>

                    <!-- Statistics Table -->
                    <div class="dashboard-card" style="grid-column: span 2;">
                        <div class="dashboard-card-title">
                            <svg class="icon icon-pulse" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: #82E0AA;">
                                <path d="M3 6h18"/>
                                <path d="M3 12h18"/>
                                <path d="M3 18h18"/>
                                <circle cx="5" cy="6" r="1" fill="#FF6B6B"/>
                                <circle cx="5" cy="12" r="1" fill="#4ECDC4"/>
                                <circle cx="5" cy="18" r="1" fill="#FFEAA7"/>
                                <rect x="19" y="5" width="2" height="2" fill="#DDA0DD"/>
                                <rect x="19" y="11" width="2" height="2" fill="#96CEB4"/>
                                <rect x="19" y="17" width="2" height="2" fill="#F7DC6F"/>
                            </svg>
                            ตารางสถิติรายละเอียด (ครบทุกคอลัมน์)
                        </div>
                        <div style="overflow-x: auto;">
                            <table class="stats-table stats-table-mobile">
                                <thead>
                                    <tr>
                                        <th>หมวดหมู่</th>
                                        <th>รายการ</th>
                                        <th>จำนวน</th>
                                        <th>เปอร์เซ็นต์</th>
                                    </tr>
                                </thead>
                                <tbody id="statsTableBody">
                                    <!-- Statistics will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">
                        <svg class="icon-lg icon-animated" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1"/>
                        </svg>
                        ตั้งค่าคอลัมน์ข้อมูล
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-section-title">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                        </svg>
                        กำหนดประเภทข้อมูลสำหรับแต่ละคอลัมน์
                    </div>
                    <div id="columnSettings" class="form-grid">
                        <!-- Column settings will be populated here -->
                    </div>
                </div>

                <div style="display: flex; gap: 16px; justify-content: flex-end; margin-top: 32px;">
                    <button class="btn btn-success" onclick="saveColumnSettings()">
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17,21 17,13 7,13 7,21"/>
                            <polyline points="7,3 7,8 15,8"/>
                        </svg>
                        บันทึกการตั้งค่า
                    </button>
                </div>
            </div>
        </div>

        <!-- Detail Modal -->
        <div id="detailModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 style="margin: 0; display: flex; align-items: center; gap: 12px;">
                        <svg class="icon-lg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                        </svg>
                        รายละเอียดผู้ป่วย
                    </h2>
                    <button class="close" onclick="closeModal()">&times;</button>
                </div>
                <div id="detailContent" class="detail-grid">
                    <!-- Detail content will be populated here -->
                </div>
            </div>
        </div>

        <!-- Success Animation -->
        <div id="successAnimation" class="success-animation">
            <svg class="success-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                <path d="M9 12l2 2 4-4"/>
                <circle cx="12" cy="12" r="10"/>
            </svg>
            <h3 style="margin: 0 0 10px 0; color: #10B981; font-size: 24px;">สำเร็จ!</h3>
            <p style="margin: 0; color: #64748B; font-size: 16px;">บันทึกการตั้งค่าเรียบร้อยแล้ว</p>
        </div>
        </div>
    </div>

    <script>
        // Google Apps Script URL
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzacIwVvVwzw4tyVl4QJluyBr-avMX6YA7rJmQBKvBPbQ-FFE5bG2ErylxPosSLodGk/exec';
        
        let patientData = [];
        let filteredData = [];
        let editingRowId = null;
        
        // Dashboard variables
        let dashboardData = [];
        let filteredDashboardData = [];
        let charts = {};

        // Updated Column mapping for Google Sheets - corrected order
        const COLUMNS = [
            'Date', 'AN', 'HN', 'Pre ward', 'Age gr.', 'Sex', 'AN type', 'AN type 2', 
            'Service', 'Dx.', 'Operation', 'Plan ICU', 'การเยี่ยมผู้ป่วย', 'Aware 1', 'Aware 2', 'Aware 3', 
            'IC', 'CVS', 'Endo', 'RS', 'Hemato', 'Other', 'Stroke Risk', 'Cardiac Risk', 
            'Malampati', 'IIG', 'MH distance', 'MT distance', 'MSD', 'AOJ extention', 
            'ASA status', 'NPO', 'รอดมยา', 'Aldrette score แรกรับ', 'Anesthesia', 'Tube', 
            'LV', 'Attempt', 'AN time', 'Start-go', 'Intra comp', 'Pre Hct', 'G/M blood', 
            'G/M FFP', 'G/M Plt Conc', 'OR G/M', 'PRC/LPRC', 'FFP', 'Plt Conc', 'Intra EBL', 
            'RR comp 1', 'RR comp 2', 'RR EBL', 'Aldrette scoreก่อนกลับตึก', 'RR time', 
            'Ward comp 1', 'Post ward', 'Pre op pain', 'pain สูงสุด', 'Last pain', 'Narcotic', 
            'Total narcotic (ครั้ง)', 'NSAIDS', 'PO pain Rx.', 'PO guideline', 'Pre an visit', 
            'Anesthetist 1', 'Anesthetist 2', 'Anesthetist 3', 'Anesthetist 4', 'RR nurse 1', 
            'RR nurse 2', 'RR nurse 3', 'Post an visit', 'Surgeon 1', 'Surgeon 2'
        ];

        // Sidebar functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const container = document.querySelector('.container');
            
            if (sidebar.classList.contains('open')) {
                closeSidebar();
            } else {
                sidebar.classList.add('open');
                overlay.classList.add('show');
                if (window.innerWidth > 768) {
                    container.classList.add('sidebar-open');
                }
            }
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const container = document.querySelector('.container');
            
            sidebar.classList.remove('open');
            overlay.classList.remove('show');
            container.classList.remove('sidebar-open');
        }

        // Show section
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.nav-item').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');

            // Always close sidebar after selection (both mobile and desktop)
            closeSidebar();

            if (sectionId === 'table') {
                loadPatientData();
            } else if (sectionId === 'settings') {
                loadColumnSettings();
            } else if (sectionId === 'dashboard') {
                loadDashboardData();
            }
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toast.className = `toast ${type}`;
            toastMessage.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }

        // Handle form submission - FIXED VERSION
        async function handleSubmit(event) {
            event.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            
            // Check if elements exist before proceeding
            if (!submitBtn || !submitText) {
                console.error('Submit button or text element not found');
                showToast('เกิดข้อผิดพลาดในระบบ', 'error');
                return;
            }
            
            const originalText = submitText.textContent;
            
            // Show loading state
            submitBtn.disabled = true;
            submitText.textContent = 'กำลังบันทึก...';
            submitBtn.innerHTML = `
                <div class="spinner"></div>
                <span>กำลังบันทึก...</span>
            `;

            try {
                const formData = new FormData(event.target);
                const data = {};
                
                // Convert FormData to object
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }

                // Determine if this is an edit or new entry
                const isEdit = editingRowId !== null;
                const action = isEdit ? 'update' : 'create';
                
                if (isEdit) {
                    data.rowId = editingRowId;
                }

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: action,
                        data: JSON.stringify(data)
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Show Sweet Alert success notification
                    if (isEdit) {
                        Swal.fire({
                            title: 'สำเร็จ!',
                            text: 'อัพเดทข้อมูลเรียบร้อยแล้ว',
                            icon: 'success',
                            confirmButtonText: 'ตกลง',
                            confirmButtonColor: '#10B981',
                            timer: 3000,
                            timerProgressBar: true
                        });
                    } else {
                        Swal.fire({
                            title: 'สำเร็จ!',
                            text: 'บันทึกข้อมูลเรียบร้อยแล้ว',
                            icon: 'success',
                            confirmButtonText: 'ตกลง',
                            confirmButtonColor: '#10B981',
                            timer: 3000,
                            timerProgressBar: true
                        });
                    }
                    
                    clearForm();
                    if (document.getElementById('table').classList.contains('active')) {
                        loadPatientData();
                    }
                } else {
                    throw new Error(result.error || 'เกิดข้อผิดพลาดในการบันทึกข้อมูล');
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('เกิดข้อผิดพลาด: ' + error.message, 'error');
            } finally {
                // Reset button state safely - check if elements still exist
                const currentSubmitBtn = document.getElementById('submitBtn');
                const currentSubmitText = document.getElementById('submitText');
                
                if (currentSubmitBtn) {
                    currentSubmitBtn.disabled = false;
                    
                    // Restore original button content
                    currentSubmitBtn.innerHTML = `
                        <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                            <polyline points="17,21 17,13 7,13 7,21"/>
                            <polyline points="7,3 7,8 15,8"/>
                        </svg>
                        <span id="submitText">${originalText}</span>
                    `;
                }
            }
        }

        // Clear form
        function clearForm() {
            const form = document.getElementById('patientForm');
            if (form) {
                form.reset();
            }
            
            editingRowId = null;
            
            const editRowIdInput = document.getElementById('editRowId');
            if (editRowIdInput) {
                editRowIdInput.value = '';
            }
            
            const editModeBtn = document.getElementById('editModeBtn');
            if (editModeBtn) {
                editModeBtn.style.display = 'none';
            }
            
            const submitText = document.getElementById('submitText');
            if (submitText) {
                submitText.textContent = 'บันทึกข้อมูล';
            }
        }

        // Load patient data from Google Sheets
        async function loadPatientData() {
            const tableBody = document.getElementById('patientTableBody');
            if (!tableBody) return;
            
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" style="text-align: center; padding: 40px;">
                        <div class="spinner" style="margin: 0 auto 16px;"></div>
                        กำลังโหลดข้อมูล...
                    </td>
                </tr>
            `;

            try {
                // Get current month and year for filtering
                const currentDate = new Date();
                const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                const currentYear = String(currentDate.getFullYear());
                
                const response = await fetch(`${SCRIPT_URL}?action=read&month=${currentMonth}&year=${currentYear}`);
                const result = await response.json();
                
                if (result.success) {
                    patientData = result.data || [];
                    filteredData = [...patientData];
                    
                    // Update month/year filter options and set current values
                    updateDateFilters();
                    
                    // Set current month/year as selected
                    const monthFilter = document.getElementById('monthFilter');
                    const yearFilter = document.getElementById('yearFilter');
                    if (monthFilter) monthFilter.value = currentMonth;
                    if (yearFilter) yearFilter.value = currentYear;
                    
                    renderTable();
                } else {
                    throw new Error(result.error || 'ไม่สามารถโหลดข้อมูลได้');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="8" style="text-align: center; padding: 40px; color: #C53030;">
                                เกิดข้อผิดพลาดในการโหลดข้อมูล: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Update date filter options based on actual data
        function updateDateFilters() {
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            
            if (!monthFilter || !yearFilter) return;
            
            // Get current month and year
            const currentDate = new Date();
            const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            const currentYear = String(currentDate.getFullYear());
            
            // Get unique months and years from data
            const months = new Set([currentMonth]); // Always include current month
            const years = new Set([currentYear]); // Always include current year
            
            patientData.forEach(patient => {
                if (patient.Date) {
                    try {
                        const date = new Date(patient.Date);
                        if (!isNaN(date.getTime())) {
                            months.add(String(date.getMonth() + 1).padStart(2, '0'));
                            years.add(String(date.getFullYear()));
                        }
                    } catch (error) {
                        // Skip invalid dates
                    }
                }
            });
            
            // Update month filter with current month first
            const monthNames = [
                '', 'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
            ];
            
            monthFilter.innerHTML = '<option value="">เลือกเดือน</option>';
            
            // Add current month first
            const currentMonthNum = parseInt(currentMonth);
            monthFilter.innerHTML += `<option value="${currentMonth}">${monthNames[currentMonthNum]} (ปัจจุบัน)</option>`;
            
            // Add other months
            Array.from(months).sort().forEach(month => {
                if (month !== currentMonth) {
                    const monthNum = parseInt(month);
                    monthFilter.innerHTML += `<option value="${month}">${monthNames[monthNum]}</option>`;
                }
            });
            
            // Update year filter with current year first (convert to Buddhist year for display)
            yearFilter.innerHTML = '<option value="">เลือกปี</option>';
            
            // Add current year first
            const currentBuddhistYear = parseInt(currentYear) + 543;
            yearFilter.innerHTML += `<option value="${currentYear}">${currentBuddhistYear} (ปัจจุบัน)</option>`;
            
            // Add other years
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                if (year !== currentYear) {
                    const buddhistYear = parseInt(year) + 543;
                    yearFilter.innerHTML += `<option value="${year}">${buddhistYear}</option>`;
                }
            });
        }

        // Format date for display
        function formatDate(dateString) {
            if (!dateString) return '-';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString;
                
                // Format as DD/MM/YYYY (Christian year)
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                
                return `${day}/${month}/${year}`;
            } catch (error) {
                return dateString;
            }
        }

        // Render table
        function renderTable() {
            const tableBody = document.getElementById('patientTableBody');
            if (!tableBody) return;
            
            if (filteredData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #64748B;">
                            ไม่พบข้อมูลผู้ป่วย
                        </td>
                    </tr>
                `;
                return;
            }

            // Sort by row ID descending (bottom rows in sheet appear at top of table)
            const sortedData = [...filteredData].sort((a, b) => {
                return (b.rowId || 0) - (a.rowId || 0);
            });

            tableBody.innerHTML = sortedData.map((patient, index) => `
                <tr>
                    <td>${formatDate(patient.Date)}</td>
                    <td>${patient.AN || '-'}</td>
                    <td>${patient.HN || '-'}</td>
                    <td>${patient['Age gr.'] || '-'}</td>
                    <td>${patient.Sex || '-'}</td>
                    <td>${patient.Operation || '-'}</td>
                    <td>${patient['Surgeon 1'] || '-'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn btn-secondary btn-sm" onclick="viewDetail(${patient.rowId || index})">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                    <circle cx="12" cy="12" r="3"/>
                                </svg>
                                ดู
                            </button>
                            <button class="btn btn-warning btn-sm" onclick="editPatient(${patient.rowId || index})">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                                แก้ไข
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deletePatient(${patient.rowId || index})">
                                <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3,6 5,6 21,6"/>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                                ลบ
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Filter table
        function filterTable() {
            const searchInput = document.getElementById('searchInput');
            const wardFilter = document.getElementById('wardFilter');
            const dateFilter = document.getElementById('dateFilter');
            const monthFilter = document.getElementById('monthFilter');
            const yearFilter = document.getElementById('yearFilter');
            
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const wardValue = wardFilter ? wardFilter.value : '';
            const dateValue = dateFilter ? dateFilter.value : '';
            const monthValue = monthFilter ? monthFilter.value : '';
            const yearValue = yearFilter ? yearFilter.value : '';

            filteredData = patientData.filter(patient => {
                const matchesSearch = !searchTerm || 
                    (patient.AN && patient.AN.toLowerCase().includes(searchTerm)) ||
                    (patient.HN && patient.HN.toLowerCase().includes(searchTerm)) ||
                    (patient['Anesthetist 1'] && patient['Anesthetist 1'].toLowerCase().includes(searchTerm)) ||
                    (patient['Surgeon 1'] && patient['Surgeon 1'].toLowerCase().includes(searchTerm)) ||
                    (patient['Surgeon 2'] && patient['Surgeon 2'].toLowerCase().includes(searchTerm));

                const matchesWard = !wardValue || patient['Pre ward'] === wardValue;
                const matchesDate = !dateValue || patient.Date === dateValue;

                // Date filtering logic - only filter if month/year is selected
                let matchesMonth = true;
                let matchesYear = true;

                if (monthValue || yearValue) {
                    if (patient.Date) {
                        try {
                            const patientDate = new Date(patient.Date);
                            if (!isNaN(patientDate.getTime())) {
                                const patientMonth = String(patientDate.getMonth() + 1).padStart(2, '0');
                                const patientYear = String(patientDate.getFullYear());

                                if (monthValue) {
                                    matchesMonth = patientMonth === monthValue;
                                }
                                if (yearValue) {
                                    matchesYear = patientYear === yearValue;
                                }
                            } else {
                                matchesMonth = false;
                                matchesYear = false;
                            }
                        } catch (error) {
                            // Skip invalid dates
                            matchesMonth = false;
                            matchesYear = false;
                        }
                    } else {
                        // No date data - exclude from filtered results when date filters are active
                        matchesMonth = false;
                        matchesYear = false;
                    }
                }

                return matchesSearch && matchesWard && matchesDate && matchesMonth && matchesYear;
            });

            renderTable();
        }

        // View patient detail
        function viewDetail(rowId) {
            const patient = patientData.find(p => (p.rowId || patientData.indexOf(p)) === rowId);
            if (!patient) return;

            const detailContent = document.getElementById('detailContent');
            if (!detailContent) return;
            
            detailContent.innerHTML = Object.entries(patient)
                .filter(([key, value]) => key !== 'rowId' && value)
                .map(([key, value]) => {
                    let displayValue = value;
                    
                    // Format date fields
                    if (key === 'Date' || key.toLowerCase().includes('date')) {
                        displayValue = formatDate(value);
                    }
                    
                    return `
                        <div class="detail-item">
                            <div class="detail-label">${key}</div>
                            <div class="detail-value">${displayValue}</div>
                        </div>
                    `;
                }).join('');

            const modal = document.getElementById('detailModal');
            if (modal) {
                modal.classList.add('show');
            }
        }

        // Edit patient
        function editPatient(rowId) {
            const patient = patientData.find(p => (p.rowId || patientData.indexOf(p)) === rowId);
            if (!patient) return;

            // Switch to form section
            showSection('form');
            const formTab = document.querySelector('[onclick="showSection(\'form\')"]');
            if (formTab) {
                formTab.classList.add('active');
            }

            // Regenerate form with current column settings
            generateDynamicForm();

            // Populate form with patient data - including all columns
            const form = document.getElementById('patientForm');
            if (!form) return;
            
            // Clear form first
            form.reset();
            
            // Populate all available data
            COLUMNS.forEach(columnName => {
                const input = form.querySelector(`[name="${columnName}"]`);
                const value = patient[columnName];
                
                if (input && value !== undefined && value !== null) {
                    // Handle different input types
                    if (input.type === 'date' && value) {
                        try {
                            const date = new Date(value);
                            if (!isNaN(date.getTime())) {
                                input.value = date.toISOString().split('T')[0];
                            } else {
                                input.value = value;
                            }
                        } catch (error) {
                            input.value = value || '';
                        }
                    } else if (input.tagName === 'SELECT') {
                        // For select elements, set the value
                        input.value = value || '';
                    } else if (input.type === 'range') {
                        // For pain scale sliders
                        input.value = value || '1';
                        // Update the display
                        const displayId = input.getAttribute('oninput')?.match(/updatePainValue\(this, '([^']+)'\)/)?.[1];
                        if (displayId) {
                            updatePainValue(input, displayId);
                        }
                    } else {
                        input.value = value || '';
                    }
                }
            });

            editingRowId = patient.rowId || rowId;
            
            const editRowIdInput = document.getElementById('editRowId');
            if (editRowIdInput) {
                editRowIdInput.value = editingRowId;
            }
            
            const editModeBtn = document.getElementById('editModeBtn');
            if (editModeBtn) {
                editModeBtn.style.display = 'inline-flex';
            }
            
            const submitText = document.getElementById('submitText');
            if (submitText) {
                submitText.textContent = 'อัพเดทข้อมูล';
            }
        }

        // Delete patient
        async function deletePatient(rowId) {
            const result = await Swal.fire({
                title: 'คุณแน่ใจหรือไม่?',
                text: 'ข้อมูลที่ลบแล้วจะไม่สามารถกู้คืนได้!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#6B7280',
                confirmButtonText: 'ใช่, ลบเลย!',
                cancelButtonText: 'ยกเลิก'
            });

            if (!result.isConfirmed) return;

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'delete',
                        rowId: rowId
                    })
                });

                const deleteResult = await response.json();
                
                if (deleteResult.success) {
                    Swal.fire({
                        title: 'ลบสำเร็จ!',
                        text: 'ข้อมูลถูกลบเรียบร้อยแล้ว',
                        icon: 'success',
                        confirmButtonColor: '#10B981',
                        timer: 2000,
                        timerProgressBar: true
                    });
                    loadPatientData();
                } else {
                    throw new Error(deleteResult.error || 'ไม่สามารถลบข้อมูลได้');
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    title: 'เกิดข้อผิดพลาด!',
                    text: error.message,
                    icon: 'error',
                    confirmButtonColor: '#EF4444'
                });
            }
        }

        // Close modal
        function closeModal() {
            const modal = document.getElementById('detailModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Load data for edit mode
        function loadDataForEdit() {
            showToast('โหมดแก้ไข: เลือกผู้ป่วยจากตารางเพื่อแก้ไขข้อมูล', 'info');
            showSection('table');
            const tableTab = document.querySelector('[onclick="showSection(\'table\')"]');
            if (tableTab) {
                tableTab.classList.add('active');
            }
        }

        // Column settings
        let columnSettings = {};
        let defaultColumnSettings = {};

        // Initialize column settings
        function initializeColumnSettings() {
            defaultColumnSettings = {
                'Date': { type: 'date', options: [] },
                'AN': { type: 'text', options: [] },
                'HN': { type: 'text', options: [] },
                'Pre ward': { type: 'select', options: ['หอผู้ป่วยใน 1', 'หอผู้ป่วยใน 2', 'หอผู้ป่วยใน 3', 'ICU', 'ER', 'OPD'] },
                'Age gr.': { type: 'select', options: ['เด็ก', 'ผู้ใหญ่', 'ผู้สูงอายุ'] },
                'Sex': { type: 'select', options: ['ชาย', 'หญิง'] },
                'AN type': { type: 'select', options: ['General', 'Spinal', 'Epidural', 'Local', 'Sedation', 'Combined'] },
                'AN type 2': { type: 'select', options: ['General', 'Spinal', 'Epidural', 'Local', 'Sedation', 'Combined'] },
                'Service': { type: 'text', options: [] },
                'Dx.': { type: 'text', options: [] },
                'Operation': { type: 'text', options: [] },
                'Plan ICU': { type: 'text', options: [] },
                'การเยี่ยมผู้ป่วย': { type: 'text', options: [] },
                'Aware 1': { type: 'text', options: [] },
                'Aware 2': { type: 'text', options: [] },
                'Aware 3': { type: 'text', options: [] },
                'IC': { type: 'text', options: [] },
                'CVS': { type: 'text', options: [] },
                'Endo': { type: 'text', options: [] },
                'RS': { type: 'text', options: [] },
                'Hemato': { type: 'text', options: [] },
                'Other': { type: 'text', options: [] },
                'Stroke Risk': { type: 'text', options: [] },
                'Cardiac Risk': { type: 'text', options: [] },
                'Malampati': { type: 'select', options: ['I', 'II', 'III', 'IV'] },
                'IIG': { type: 'text', options: [] },
                'MH distance': { type: 'number', options: [] },
                'MT distance': { type: 'number', options: [] },
                'MSD': { type: 'text', options: [] },
                'AOJ extention': { type: 'text', options: [] },
                'ASA status': { type: 'select', options: ['I', 'II', 'III', 'IV', 'V'] },
                'NPO': { type: 'number', options: [] },
                'รอดมยา': { type: 'text', options: [] },
                'Aldrette score แรกรับ': { type: 'number', options: [] },
                'Anesthesia': { type: 'text', options: [] },
                'Tube': { type: 'text', options: [] },
                'LV': { type: 'text', options: [] },
                'Attempt': { type: 'number', options: [] },
                'AN time': { type: 'number', options: [] },
                'Start-go': { type: 'number', options: [] },
                'Intra comp': { type: 'text', options: [] },
                'Pre Hct': { type: 'number', options: [] },
                'G/M blood': { type: 'number', options: [] },
                'G/M FFP': { type: 'number', options: [] },
                'G/M Plt Conc': { type: 'number', options: [] },
                'OR G/M': { type: 'number', options: [] },
                'PRC/LPRC': { type: 'number', options: [] },
                'FFP': { type: 'number', options: [] },
                'Plt Conc': { type: 'number', options: [] },
                'Intra EBL': { type: 'number', options: [] },
                'RR comp 1': { type: 'text', options: [] },
                'RR comp 2': { type: 'text', options: [] },
                'RR EBL': { type: 'number', options: [] },
                'Aldrette scoreก่อนกลับตึก': { type: 'number', options: [] },
                'RR time': { type: 'number', options: [] },
                'Ward comp 1': { type: 'text', options: [] },
                'Post ward': { type: 'text', options: [] },
                'Pre op pain': { type: 'number', options: [] },
                'pain สูงสุด': { type: 'number', options: [] },
                'Last pain': { type: 'number', options: [] },
                'Narcotic': { type: 'text', options: [] },
                'Total narcotic (ครั้ง)': { type: 'number', options: [] },
                'NSAIDS': { type: 'text', options: [] },
                'PO pain Rx.': { type: 'text', options: [] },
                'PO guideline': { type: 'text', options: [] },
                'Pre an visit': { type: 'text', options: [] },
                'Anesthetist 1': { type: 'text', options: [] },
                'Anesthetist 2': { type: 'text', options: [] },
                'Anesthetist 3': { type: 'text', options: [] },
                'Anesthetist 4': { type: 'text', options: [] },
                'RR nurse 1': { type: 'text', options: [] },
                'RR nurse 2': { type: 'text', options: [] },
                'RR nurse 3': { type: 'text', options: [] },
                'Post an visit': { type: 'text', options: [] },
                'Surgeon 1': { type: 'text', options: [] },
                'Surgeon 2': { type: 'text', options: [] }
            };

            // Load from Google Sheets first, then fallback to localStorage or defaults
            loadColumnSettings();
        }

        // Load column settings from Google Sheets
        async function loadColumnSettings() {
            try {
                showToast('กำลังโหลดการตั้งค่า...', 'info');
                
                const response = await fetch(`${SCRIPT_URL}?action=getSettings`);
                const result = await response.json();
                
                console.log('Settings response:', result); // Debug log
                
                if (result.success && result.data && Object.keys(result.data).length > 0) {
                    // Settings found in Google Sheets
                    columnSettings = result.data;
                    showToast('โหลดการตั้งค่าจาก Google Sheets เรียบร้อยแล้ว', 'success');
                } else {
                    // No settings found, extract all column options from actual data
                    columnSettings = JSON.parse(JSON.stringify(defaultColumnSettings));
                    
                    try {
                        const dataResponse = await fetch(`${SCRIPT_URL}?action=readAll`);
                        const dataResult = await dataResponse.json();
                        
                        if (dataResult.success && dataResult.data && dataResult.data.length > 0) {
                            // Extract unique values for all columns from actual data
                            COLUMNS.forEach(columnName => {
                                const uniqueValues = [...new Set(
                                    dataResult.data
                                        .map(patient => patient[columnName])
                                        .filter(value => value && value.toString().trim() !== '')
                                        .map(value => value.toString().trim())
                                )].sort();
                                
                                if (uniqueValues.length > 0) {
                                    // If we have actual data for this column, update the options
                                    if (uniqueValues.length <= 50) { // Only convert to select if reasonable number of options
                                        // Check if values look like categories (not too many unique values)
                                        const shouldBeSelect = 
                                            uniqueValues.length <= 20 || // Small number of options
                                            columnName.includes('ward') || 
                                            columnName.includes('type') || 
                                            columnName.includes('status') || 
                                            columnName.includes('Sex') ||
                                            columnName.includes('Age gr.') ||
                                            columnName.includes('Malampati') ||
                                            columnName.includes('ASA') ||
                                            columnName.includes('Plan ICU') ||
                                            columnName.includes('Service') ||
                                            columnName.includes('Anesthetist') ||
                                            columnName.includes('Surgeon') ||
                                            columnName.includes('nurse');
                                        
                                        if (shouldBeSelect) {
                                            columnSettings[columnName].type = 'select';
                                            columnSettings[columnName].options = uniqueValues;
                                        }
                                    }
                                }
                            });
                            
                            showToast('ดึงตัวเลือกจากข้อมูลจริงในชีตเรียบร้อยแล้ว', 'success');
                        } else {
                            showToast('ไม่พบการตั้งค่าใน Google Sheets ใช้การตั้งค่าเริ่มต้น', 'info');
                        }
                    } catch (dataError) {
                        console.error('Error loading data for column options:', dataError);
                        showToast('ไม่พบการตั้งค่าใน Google Sheets ใช้การตั้งค่าเริ่มต้น', 'info');
                    }
                }
                
                renderColumnSettings();
                generateDynamicForm();
                updateWardFilterOptions();
                
            } catch (error) {
                console.error('Error loading settings:', error);
                // Use defaults on error
                columnSettings = JSON.parse(JSON.stringify(defaultColumnSettings));
                renderColumnSettings();
                generateDynamicForm();
                updateWardFilterOptions();
                showToast('เกิดข้อผิดพลาดในการโหลดการตั้งค่า ใช้การตั้งค่าเริ่มต้น', 'error');
            }
        }

        // Reset column settings to defaults
        function resetColumnSettings() {
            Swal.fire({
                title: 'คุณแน่ใจหรือไม่?',
                text: 'การตั้งค่าทั้งหมดจะถูกรีเซ็ตเป็นค่าเริ่มต้น',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#6B7280',
                confirmButtonText: 'ใช่, รีเซ็ต!',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    columnSettings = JSON.parse(JSON.stringify(defaultColumnSettings));
                    renderColumnSettings();
                    generateDynamicForm();
                    updateWardFilterOptions();
                    showToast('รีเซ็ตการตั้งค่าเรียบร้อยแล้ว', 'success');
                }
            });
        }

        // Render column settings
        function renderColumnSettings() {
            const container = document.getElementById('columnSettings');
            if (!container) return;
            
            container.innerHTML = COLUMNS.map((column, index) => {
                const setting = columnSettings[column] || { type: 'text', options: [] };
                const uniqueId = `column_${index}`;
                return `
                    <div class="form-group">
                        <label class="form-label">${column}</label>
                        <select class="form-select" id="${uniqueId}_type" onchange="updateColumnType('${column}', this.value)">
                            <option value="text" ${setting.type === 'text' ? 'selected' : ''}>ข้อความ</option>
                            <option value="number" ${setting.type === 'number' ? 'selected' : ''}>ตัวเลข</option>
                            <option value="date" ${setting.type === 'date' ? 'selected' : ''}>วันที่</option>
                            <option value="select" ${setting.type === 'select' ? 'selected' : ''}>ตัวเลือก</option>
                        </select>
                        <div id="${uniqueId}_options" style="display: ${setting.type === 'select' ? 'block' : 'none'}; margin-top: 8px;">
                            <textarea class="form-textarea" id="${uniqueId}_textarea" placeholder="ใส่ตัวเลือก (แยกด้วยเครื่องหมายจุลภาค)" 
                                onchange="updateColumnOptions('${column}', this.value)">${setting.options.join(', ')}</textarea>
                            <div style="display: flex; gap: 8px; margin-top: 8px;">
                                <button type="button" class="btn btn-sm btn-success" onclick="addOption('${column}', '${uniqueId}')">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    เพิ่ม
                                </button>
                                <button type="button" class="btn btn-sm btn-danger" onclick="clearOptions('${column}', '${uniqueId}')">
                                    <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18"/>
                                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                    </svg>
                                    ล้าง
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update column type
        function updateColumnType(column, type) {
            if (!columnSettings[column]) {
                columnSettings[column] = { type: 'text', options: [] };
            }
            columnSettings[column].type = type;
            
            // Show/hide options textarea based on type
            const columnIndex = COLUMNS.indexOf(column);
            const optionsDiv = document.getElementById(`column_${columnIndex}_options`);
            if (optionsDiv) {
                optionsDiv.style.display = type === 'select' ? 'block' : 'none';
            }
        }

        // Update column options
        function updateColumnOptions(column, optionsString) {
            if (!columnSettings[column]) {
                columnSettings[column] = { type: 'select', options: [] };
            }
            columnSettings[column].options = optionsString.split(',').map(opt => opt.trim()).filter(opt => opt);
        }

        // Add new option
        async function addOption(column, uniqueId) {
            const { value: newOption } = await Swal.fire({
                title: 'เพิ่มตัวเลือกใหม่',
                input: 'text',
                inputLabel: `เพิ่มตัวเลือกสำหรับ ${column}`,
                inputPlaceholder: 'ใส่ตัวเลือกใหม่...',
                showCancelButton: true,
                confirmButtonText: 'เพิ่ม',
                cancelButtonText: 'ยกเลิก',
                inputValidator: (value) => {
                    if (!value) {
                        return 'กรุณาใส่ตัวเลือก';
                    }
                }
            });

            if (newOption) {
                if (!columnSettings[column]) {
                    columnSettings[column] = { type: 'select', options: [] };
                }
                
                if (!columnSettings[column].options.includes(newOption)) {
                    columnSettings[column].options.push(newOption);
                    
                    // Update textarea
                    const textarea = document.getElementById(`${uniqueId}_textarea`);
                    if (textarea) {
                        textarea.value = columnSettings[column].options.join(', ');
                    }
                    
                    showToast(`เพิ่มตัวเลือก "${newOption}" เรียบร้อยแล้ว`, 'success');
                } else {
                    showToast('ตัวเลือกนี้มีอยู่แล้ว', 'error');
                }
            }
        }

        // Clear all options
        function clearOptions(column, uniqueId) {
            Swal.fire({
                title: 'คุณแน่ใจหรือไม่?',
                text: `ตัวเลือกทั้งหมดของ ${column} จะถูกลบ`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#EF4444',
                cancelButtonColor: '#6B7280',
                confirmButtonText: 'ใช่, ลบทั้งหมด!',
                cancelButtonText: 'ยกเลิก'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (columnSettings[column]) {
                        columnSettings[column].options = [];
                        
                        // Update textarea
                        const textarea = document.getElementById(`${uniqueId}_textarea`);
                        if (textarea) {
                            textarea.value = '';
                        }
                        
                        showToast('ลบตัวเลือกทั้งหมดเรียบร้อยแล้ว', 'success');
                    }
                }
            });
        }

        // Save column settings to Google Sheets
        async function saveColumnSettings() {
            try {
                showToast('กำลังบันทึกการตั้งค่า...', 'info');
                
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'saveSettings',
                        settings: JSON.stringify(columnSettings)
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Also save to localStorage as backup
                    localStorage.setItem('columnSettings', JSON.stringify(columnSettings));
                    
                    // Show success animation
                    const successAnimation = document.getElementById('successAnimation');
                    if (successAnimation) {
                        successAnimation.classList.add('show');
                        
                        setTimeout(() => {
                            successAnimation.classList.remove('show');
                        }, 3000);
                    }
                    
                    // Regenerate form with new settings
                    generateDynamicForm();
                    updateWardFilterOptions();
                    
                    showToast('บันทึกการตั้งค่าเรียบร้อยแล้ว', 'success');
                } else {
                    throw new Error(result.error || 'ไม่สามารถบันทึกการตั้งค่าได้');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                
                // Save to localStorage as fallback
                localStorage.setItem('columnSettings', JSON.stringify(columnSettings));
                generateDynamicForm();
                updateWardFilterOptions();
                
                showToast('บันทึกการตั้งค่าในเครื่องเรียบร้อยแล้ว (ไม่สามารถซิงค์กับเซิร์ฟเวอร์ได้)', 'warning');
            }
        }

        // Generate dynamic form based on column settings
        function generateDynamicForm() {
            const formSections = document.querySelectorAll('.form-section');
            
            // Update existing form inputs based on column settings
            formSections.forEach(section => {
                const inputs = section.querySelectorAll('.form-input, .form-select, .form-textarea');
                inputs.forEach(input => {
                    const fieldName = input.getAttribute('name');
                    if (fieldName && columnSettings[fieldName]) {
                        const setting = columnSettings[fieldName];
                        const formGroup = input.closest('.form-group');
                        const currentValue = input.value;
                        
                        if (setting.type === 'select' && setting.options.length > 0) {
                            // Convert to select
                            if (input.tagName !== 'SELECT') {
                                const newSelect = document.createElement('select');
                                newSelect.className = 'form-select';
                                newSelect.name = fieldName;
                                const labelText = formGroup.querySelector('.form-label').textContent.replace(' *', '');
                                newSelect.innerHTML = `
                                    <option value="">เลือก${labelText}</option>
                                    ${setting.options.map(opt => `<option value="${opt}" ${opt === currentValue ? 'selected' : ''}>${opt}</option>`).join('')}
                                `;
                                input.parentNode.replaceChild(newSelect, input);
                            } else {
                                // Update existing select options
                                const selectedValue = input.value;
                                const labelText = formGroup.querySelector('.form-label').textContent.replace(' *', '');
                                input.innerHTML = `
                                    <option value="">เลือก${labelText}</option>
                                    ${setting.options.map(opt => `<option value="${opt}" ${opt === selectedValue ? 'selected' : ''}>${opt}</option>`).join('')}
                                `;
                            }
                        } else if (setting.type === 'number') {
                            if (input.type !== 'number' || input.tagName === 'SELECT') {
                                const newInput = document.createElement('input');
                                newInput.type = 'number';
                                newInput.className = 'form-input';
                                newInput.name = fieldName;
                                newInput.value = currentValue;
                                if (fieldName === 'Date' && input.hasAttribute('required')) {
                                    newInput.required = true;
                                }
                                if (fieldName === 'AN' && input.hasAttribute('required')) {
                                    newInput.required = true;
                                }
                                if (fieldName === 'HN' && input.hasAttribute('required')) {
                                    newInput.required = true;
                                }
                                input.parentNode.replaceChild(newInput, input);
                            }
                        } else if (setting.type === 'date') {
                            if (input.type !== 'date' || input.tagName === 'SELECT') {
                                const newInput = document.createElement('input');
                                newInput.type = 'date';
                                newInput.className = 'form-input';
                                newInput.name = fieldName;
                                newInput.value = currentValue;
                                if (fieldName === 'Date' && input.hasAttribute('required')) {
                                    newInput.required = true;
                                }
                                input.parentNode.replaceChild(newInput, input);
                            }
                        } else {
                            if (input.type !== 'text' || input.tagName === 'SELECT') {
                                const newInput = document.createElement('input');
                                newInput.type = 'text';
                                newInput.className = 'form-input';
                                newInput.name = fieldName;
                                newInput.value = currentValue;
                                if (fieldName === 'AN' && input.hasAttribute('required')) {
                                    newInput.required = true;
                                }
                                if (fieldName === 'HN' && input.hasAttribute('required')) {
                                    newInput.required = true;
                                }
                                input.parentNode.replaceChild(newInput, input);
                            }
                        }
                    }
                });
            });
            
            // Update ward filter options to match Pre ward settings
            updateWardFilterOptions();
        }
        
        // Update ward filter options based on Pre ward column settings
        function updateWardFilterOptions() {
            const wardFilter = document.getElementById('wardFilter');
            if (!wardFilter) return;
            
            const preWardSetting = columnSettings['Pre ward'];
            
            if (preWardSetting && preWardSetting.type === 'select' && preWardSetting.options.length > 0) {
                const currentValue = wardFilter.value;
                wardFilter.innerHTML = `
                    <option value="">ทุกหอผู้ป่วย</option>
                    ${preWardSetting.options.map(opt => `<option value="${opt}" ${opt === currentValue ? 'selected' : ''}>${opt}</option>`).join('')}
                `;
            }
        }

        // Update pain scale value display
        function updatePainValue(slider, displayId) {
            const value = parseInt(slider.value);
            const display = document.getElementById(displayId);
            if (!display) return;
            
            const painLevels = {
                1: 'เจ็บน้อยที่สุด',
                2: 'เจ็บน้อย',
                3: 'เจ็บน้อยปานกลาง',
                4: 'เจ็บปานกลาง',
                5: 'เจ็บปานกลาง-มาก',
                6: 'เจ็บมาก',
                7: 'เจ็บมากขึ้น',
                8: 'เจ็บมากมาก',
                9: 'เจ็บรุนแรง',
                10: 'เจ็บที่สุด'
            };
            
            display.textContent = `${value} - ${painLevels[value]}`;
            display.className = `pain-scale-value pain-value-${value}`;
        }

        // Dashboard Functions
        async function loadDashboardData() {
            try {
                // Clear any existing error messages
                const dashboardCards = document.querySelectorAll('.dashboard-card');
                dashboardCards.forEach(card => {
                    const existingError = card.querySelector('.error-message');
                    if (existingError) {
                        existingError.remove();
                    }
                });
                
                showToast('กำลังโหลดข้อมูลแดชบอร์ด...', 'info');
                
                const response = await fetch(`${SCRIPT_URL}?action=readAll`);
                const result = await response.json();
                
                if (result.success) {
                    dashboardData = result.data || [];
                    
                    // Get current month and year for initial load
                    const currentDate = new Date();
                    const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
                    const currentYear = String(currentDate.getFullYear());
                    
                    updateDashboardFilters();
                    
                    // Set current month and year as default
                    const monthFilter = document.getElementById('dashboardMonthFilter');
                    const yearFilter = document.getElementById('dashboardYearFilter');
                    if (monthFilter) monthFilter.value = currentMonth;
                    if (yearFilter) yearFilter.value = currentYear;
                    
                    // Apply initial filter
                    filterDashboardData();
                    
                    showToast('โหลดข้อมูลแดชบอร์ดเรียบร้อยแล้ว', 'success');
                } else {
                    throw new Error(result.error || 'ไม่สามารถโหลดข้อมูลได้');
                }
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                
                // Show error in dashboard cards instead of persistent toast
                const dashboardCards = document.querySelectorAll('.dashboard-card');
                dashboardCards.forEach(card => {
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'error-message';
                    errorDiv.style.cssText = 'text-align: center; padding: 20px; color: #EF4444; background: #FEF2F2; border-radius: 12px; margin: 10px 0;';
                    errorDiv.innerHTML = `
                        <svg style="width: 24px; height: 24px; margin-bottom: 8px;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="15" y1="9" x2="9" y2="15"/>
                            <line x1="9" y1="9" x2="15" y2="15"/>
                        </svg>
                        <div>เกิดข้อผิดพลาดในการโหลดข้อมูล</div>
                        <div style="font-size: 12px; margin-top: 4px;">${error.message}</div>
                    `;
                    card.appendChild(errorDiv);
                });
                
                // Initialize empty data to prevent further errors
                dashboardData = [];
                filteredDashboardData = [];
                updateDashboardFilters();
            }
        }

        function updateDashboardFilters() {
            const monthFilter = document.getElementById('dashboardMonthFilter');
            const yearFilter = document.getElementById('dashboardYearFilter');
            const surgeonFilter = document.getElementById('dashboardSurgeonFilter');
            
            if (!monthFilter || !yearFilter || !surgeonFilter) return;
            
            // Get current date
            const currentDate = new Date();
            const currentMonth = String(currentDate.getMonth() + 1).padStart(2, '0');
            const currentYear = String(currentDate.getFullYear());
            
            // Get unique values from data
            const months = new Set([currentMonth]);
            const years = new Set([currentYear]);
            const surgeons = new Set();
            
            dashboardData.forEach(patient => {
                if (patient.Date) {
                    try {
                        const date = new Date(patient.Date);
                        if (!isNaN(date.getTime())) {
                            months.add(String(date.getMonth() + 1).padStart(2, '0'));
                            years.add(String(date.getFullYear()));
                        }
                    } catch (error) {
                        // Skip invalid dates
                    }
                }
                
                if (patient['Surgeon 1']) {
                    surgeons.add(patient['Surgeon 1']);
                }
            });
            
            // Update month filter
            const monthNames = [
                '', 'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
            ];
            
            monthFilter.innerHTML = '<option value="">ทุกเดือน</option>';
            Array.from(months).sort().forEach(month => {
                const monthNum = parseInt(month);
                const isCurrent = month === currentMonth;
                monthFilter.innerHTML += `<option value="${month}">${monthNames[monthNum]}${isCurrent ? ' (ปัจจุบัน)' : ''}</option>`;
            });
            
            // Update year filter
            yearFilter.innerHTML = '<option value="">ทุกปี</option>';
            Array.from(years).sort((a, b) => b - a).forEach(year => {
                const buddhistYear = parseInt(year) + 543;
                const isCurrent = year === currentYear;
                yearFilter.innerHTML += `<option value="${year}">${buddhistYear}${isCurrent ? ' (ปัจจุบัน)' : ''}</option>`;
            });
            
            // Update surgeon filter
            surgeonFilter.innerHTML = '<option value="">ทุกแพทย์</option>';
            Array.from(surgeons).sort().forEach(surgeon => {
                surgeonFilter.innerHTML += `<option value="${surgeon}">${surgeon}</option>`;
            });
            
            // Set current month and year as default
            monthFilter.value = currentMonth;
            yearFilter.value = currentYear;
        }

        function filterDashboardData() {
            const searchInput = document.getElementById('dashboardSearchInput');
            const monthFilter = document.getElementById('dashboardMonthFilter');
            const yearFilter = document.getElementById('dashboardYearFilter');
            const surgeonFilter = document.getElementById('dashboardSurgeonFilter');
            
            const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
            const monthValue = monthFilter ? monthFilter.value : '';
            const yearValue = yearFilter ? yearFilter.value : '';
            const surgeonValue = surgeonFilter ? surgeonFilter.value : '';

            filteredDashboardData = dashboardData.filter(patient => {
                const matchesSearch = !searchTerm || 
                    (patient.AN && patient.AN.toLowerCase().includes(searchTerm)) ||
                    (patient.HN && patient.HN.toLowerCase().includes(searchTerm)) ||
                    (patient['Surgeon 1'] && patient['Surgeon 1'].toLowerCase().includes(searchTerm)) ||
                    (patient['AN type'] && patient['AN type'].toLowerCase().includes(searchTerm));

                const matchesSurgeon = !surgeonValue || patient['Surgeon 1'] === surgeonValue;

                let matchesMonth = true;
                let matchesYear = true;

                if (monthValue || yearValue) {
                    if (patient.Date) {
                        try {
                            const patientDate = new Date(patient.Date);
                            if (!isNaN(patientDate.getTime())) {
                                const patientMonth = String(patientDate.getMonth() + 1).padStart(2, '0');
                                const patientYear = String(patientDate.getFullYear());

                                if (monthValue) {
                                    matchesMonth = patientMonth === monthValue;
                                }
                                if (yearValue) {
                                    matchesYear = patientYear === yearValue;
                                }
                            } else {
                                matchesMonth = false;
                                matchesYear = false;
                            }
                        } catch (error) {
                            matchesMonth = false;
                            matchesYear = false;
                        }
                    } else {
                        matchesMonth = false;
                        matchesYear = false;
                    }
                }

                return matchesSearch && matchesSurgeon && matchesMonth && matchesYear;
            });

            renderDashboard();
        }

        function renderDashboard() {
            renderPatientTrendChart();
            renderGenderChart();
            renderAnTypeChart();
            renderPreWardChart();
            renderAgeGroupMetrics();
            renderServiceTypeMetrics();
            renderTimePeriodMetrics();
            renderIcuPlanMetrics();
            renderOperationTrendChart();
            renderStatsTable();
        }

        function renderPatientTrendChart() {
            const ctx = document.getElementById('patientTrendChart');
            if (!ctx) return;

            // Destroy existing chart
            if (charts.patientTrend) {
                charts.patientTrend.destroy();
            }

            // Group data by day and surgeon (only for filtered data)
            const daySurgeonData = {};
            
            filteredDashboardData.forEach(patient => {
                if (patient.Date && patient['Surgeon 1']) {
                    try {
                        const date = new Date(patient.Date);
                        const dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        const surgeon = patient['Surgeon 1'];
                        
                        if (!daySurgeonData[dayKey]) {
                            daySurgeonData[dayKey] = {};
                        }
                        if (!daySurgeonData[dayKey][surgeon]) {
                            daySurgeonData[dayKey][surgeon] = 0;
                        }
                        daySurgeonData[dayKey][surgeon]++;
                    } catch (error) {
                        // Skip invalid dates
                    }
                }
            });

            const days = Object.keys(daySurgeonData).sort();
            const surgeons = [...new Set(filteredDashboardData.map(p => p['Surgeon 1']).filter(s => s))];
            
            const colors = [
                '#3B82F6', '#EF4444', '#10B981', '#F59E0B', '#8B5CF6',
                '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
            ];

            // Format day labels for display (DD/MM)
            const dayLabels = days.map(dayKey => {
                const [year, month, day] = dayKey.split('-');
                return `${day}/${month}`;
            });

            const datasets = surgeons.slice(0, 10).map((surgeon, index) => ({
                label: surgeon,
                data: days.map(day => daySurgeonData[day]?.[surgeon] || 0),
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '20',
                tension: 0.4,
                fill: false,
                pointRadius: 4,
                pointHoverRadius: 6
            }));

            charts.patientTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dayLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'แนวโน้มผู้ป่วยรายวัน (แยกตามแพทย์)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 15
                            }
                        }
                    }
                }
            });
        }

        function renderGenderChart() {
            const ctx = document.getElementById('genderChart');
            if (!ctx) return;

            if (charts.gender) {
                charts.gender.destroy();
            }

            const genderCounts = {};
            filteredDashboardData.forEach(patient => {
                const gender = patient.Sex || 'ไม่ระบุ';
                genderCounts[gender] = (genderCounts[gender] || 0) + 1;
            });

            const labels = Object.keys(genderCounts);
            const data = Object.values(genderCounts);
            const colors = ['#EC4899', '#3B82F6', '#10B981', '#F59E0B'];

            charts.gender = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 3,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 4,
                        hoverOffset: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 800,
                        easing: 'easeOutBounce'
                    }
                }
            });
        }

        function renderAnTypeChart() {
            const ctx = document.getElementById('anTypeChart');
            if (!ctx) return;

            if (charts.anType) {
                charts.anType.destroy();
            }

            const anTypeCounts = {};
            filteredDashboardData.forEach(patient => {
                const anType = patient['AN type'] || 'ไม่ระบุ';
                anTypeCounts[anType] = (anTypeCounts[anType] || 0) + 1;
            });

            const labels = Object.keys(anTypeCounts);
            const data = Object.values(anTypeCounts);
            const colors = ['#8B5CF6', '#EF4444', '#10B981', '#F59E0B', '#06B6D4', '#EC4899'];

            charts.anType = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 3,
                        borderColor: '#ffffff',
                        hoverBorderWidth: 4,
                        hoverOffset: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 10,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        }
                    },
                    animation: {
                        animateRotate: true,
                        animateScale: true,
                        duration: 800,
                        easing: 'easeOutBounce'
                    }
                }
            });
        }

        function renderPreWardChart() {
            const ctx = document.getElementById('preWardChart');
            if (!ctx) return;

            if (charts.preWard) {
                charts.preWard.destroy();
            }

            const wardCounts = {};
            filteredDashboardData.forEach(patient => {
                const ward = patient['Pre ward'] || 'ไม่ระบุ';
                wardCounts[ward] = (wardCounts[ward] || 0) + 1;
            });

            const labels = Object.keys(wardCounts);
            const data = Object.values(wardCounts);
            const colors = ['#10B981', '#3B82F6', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];

            charts.preWard = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors.slice(0, labels.length),
                        borderWidth: 2,
                        borderColor: '#ffffff',
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 45
                            }
                        }
                    },
                    animation: {
                        duration: 800,
                        easing: 'easeOutBounce'
                    }
                }
            });
        }

        function renderAgeGroupMetrics() {
            const container = document.getElementById('ageGroupMetrics');
            if (!container) return;

            const ageGroups = {
                'น้อยกว่า 1 ปี': 0,
                '1-15 ปี': 0,
                '16-65 ปี': 0,
                'มากกว่า 65 ปี': 0
            };

            filteredDashboardData.forEach(patient => {
                // Get age from column E (Age gr.) - this is the 5th column (index 4)
                // Based on COLUMNS array: ['Date', 'AN', 'HN', 'Pre ward', 'Age gr.', ...]
                let age = null;
                
                // First try to get numeric age from Age gr. field
                const ageField = patient['Age gr.'];
                if (ageField) {
                    // Try to extract number from the field
                    const ageMatch = ageField.toString().match(/\d+/);
                    if (ageMatch) {
                        age = parseInt(ageMatch[0]);
                    } else {
                        // If no number found, categorize by text
                        const ageText = ageField.toLowerCase();
                        if (ageText.includes('เด็ก') || ageText.includes('child') || ageText.includes('pediatric')) {
                            age = 8; // Representative age for children
                        } else if (ageText.includes('ผู้ใหญ่') || ageText.includes('adult') || ageText.includes('young')) {
                            age = 40; // Representative age for adults
                        } else if (ageText.includes('ผู้สูงอายุ') || ageText.includes('elderly') || ageText.includes('geriatric')) {
                            age = 70; // Representative age for elderly
                        }
                    }
                }
                
                // Categorize by age ranges
                if (age !== null && !isNaN(age)) {
                    if (age < 1) {
                        ageGroups['น้อยกว่า 1 ปี']++;
                    } else if (age >= 1 && age <= 15) {
                        ageGroups['1-15 ปี']++;
                    } else if (age >= 16 && age <= 65) {
                        ageGroups['16-65 ปี']++;
                    } else if (age > 65) {
                        ageGroups['มากกว่า 65 ปี']++;
                    }
                }
            });

            const total = Object.values(ageGroups).reduce((sum, count) => sum + count, 0);
            
            if (total === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #64748B;">
                        ไม่พบข้อมูลกลุ่มอายุ
                    </div>
                `;
                return;
            }
            
            container.innerHTML = Object.entries(ageGroups).map(([group, count], index) => {
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                return `
                    <div class="metric-card metric-age-${index + 1}">
                        <div class="metric-value">${count}</div>
                        <div class="metric-label">${group} (${percentage}%)</div>
                    </div>
                `;
            }).join('');
        }

        function renderServiceTypeMetrics() {
            const container = document.getElementById('serviceTypeMetrics');
            if (!container) return;

            const serviceTypes = {
                'IPD': 0,
                'OPD': 0,
                'OPD-IPD': 0,
                'IPD-SMC': 0,
                'OPD-SMC': 0
            };

            filteredDashboardData.forEach(patient => {
                // Get data from column G (AN type 2) - this is the 8th column (index 7)
                // Based on COLUMNS array: ['Date', 'AN', 'HN', 'Pre ward', 'Age gr.', 'Sex', 'AN type', 'AN type 2', ...]
                const anType2 = patient['AN type 2'] || '';
                const anType2Lower = anType2.toLowerCase();
                
                // Categorize based on column G content
                if (anType2Lower.includes('ipd-smc') || anType2Lower.includes('ipd smc')) {
                    serviceTypes['IPD-SMC']++;
                } else if (anType2Lower.includes('opd-smc') || anType2Lower.includes('opd smc')) {
                    serviceTypes['OPD-SMC']++;
                } else if (anType2Lower.includes('opd-ipd') || anType2Lower.includes('opd ipd')) {
                    serviceTypes['OPD-IPD']++;
                } else if (anType2Lower.includes('ipd')) {
                    serviceTypes['IPD']++;
                } else if (anType2Lower.includes('opd')) {
                    serviceTypes['OPD']++;
                } else {
                    // If column G is empty or doesn't match patterns, default to IPD
                    serviceTypes['IPD']++;
                }
            });

            const total = Object.values(serviceTypes).reduce((sum, count) => sum + count, 0);
            
            if (total === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #64748B;">
                        ไม่พบข้อมูลประเภทบริการ
                    </div>
                `;
                return;
            }
            
            container.innerHTML = Object.entries(serviceTypes).map(([type, count], index) => {
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                return `
                    <div class="metric-card metric-service-${index + 1}">
                        <div class="metric-value">${count}</div>
                        <div class="metric-label">${type} (${percentage}%)</div>
                    </div>
                `;
            }).join('');
        }

        function renderTimePeriodMetrics() {
            const container = document.getElementById('timePeriodMetrics');
            if (!container) return;

            const timePeriods = {
                'ในเวลาราชการ': 0,
                'นอกเวลาราชการ': 0,
                'ใน-นอกเวลาราชการ': 0,
                'นอก-ในเวลาราชการ': 0
            };

            filteredDashboardData.forEach(patient => {
                // Get data from column H (Service) - this is the 9th column (index 8)
                // Based on COLUMNS array: ['Date', 'AN', 'HN', 'Pre ward', 'Age gr.', 'Sex', 'AN type', 'AN type 2', 'Service', ...]
                const serviceField = patient['Service'] || '';
                const serviceFieldLower = serviceField.toLowerCase();
                
                // Categorize based on column H content
                if (serviceFieldLower.includes('ใน-นอกเวลาราชการ') || serviceFieldLower.includes('ใน-นอก')) {
                    timePeriods['ใน-นอกเวลาราชการ']++;
                } else if (serviceFieldLower.includes('นอก-ในเวลาราชการ') || serviceFieldLower.includes('นอก-ใน')) {
                    timePeriods['นอก-ในเวลาราชการ']++;
                } else if (serviceFieldLower.includes('นอกเวลาราชการ') || serviceFieldLower.includes('นอกเวลา') || 
                          serviceFieldLower.includes('after hours') || serviceFieldLower.includes('emergency')) {
                    timePeriods['นอกเวลาราชการ']++;
                } else if (serviceFieldLower.includes('ในเวลาราชการ') || serviceFieldLower.includes('ในเวลา') || 
                          serviceFieldLower.includes('office hours') || serviceFieldLower.includes('regular')) {
                    timePeriods['ในเวลาราชการ']++;
                } else {
                    // If column H doesn't contain time period info, default to ในเวลาราชการ
                    timePeriods['ในเวลาราชการ']++;
                }
            });

            const total = Object.values(timePeriods).reduce((sum, count) => sum + count, 0);
            
            if (total === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #64748B;">
                        ไม่พบข้อมูลเวลาราชการ
                    </div>
                `;
                return;
            }
            
            container.innerHTML = Object.entries(timePeriods).map(([period, count], index) => {
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                return `
                    <div class="metric-card metric-time-${index + 1}">
                        <div class="metric-value">${count}</div>
                        <div class="metric-label">${period} (${percentage}%)</div>
                    </div>
                `;
            }).join('');
        }

        function renderIcuPlanMetrics() {
            const container = document.getElementById('icuPlanMetrics');
            if (!container) return;

            const icuPlans = {
                'Plan ICU': 0,
                'UN Plan ICU': 0
            };

            filteredDashboardData.forEach(patient => {
                // Get data from column L (Plan ICU) - this is the 12th column (index 11)
                // Based on COLUMNS array: ['Date', 'AN', 'HN', 'Pre ward', 'Age gr.', 'Sex', 'AN type', 'AN type 2', 'Service', 'Dx.', 'Operation', 'Plan ICU', ...]
                const planIcu = patient['Plan ICU'] || '';
                const planIcuLower = planIcu.toLowerCase().trim();
                
                // Categorize based on column L content
                if (planIcuLower !== '' && 
                    (planIcuLower.includes('plan') || planIcuLower.includes('icu') || 
                     planIcuLower.includes('yes') || planIcuLower.includes('ใช่') || 
                     planIcuLower.includes('มี') || planIcuLower === '1' || planIcuLower === 'true')) {
                    icuPlans['Plan ICU']++;
                } else {
                    icuPlans['UN Plan ICU']++;
                }
            });

            const total = Object.values(icuPlans).reduce((sum, count) => sum + count, 0);
            
            if (total === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #64748B;">
                        ไม่พบข้อมูลแผน ICU
                    </div>
                `;
                return;
            }
            
            container.innerHTML = Object.entries(icuPlans).map(([plan, count], index) => {
                const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                return `
                    <div class="metric-card metric-icu-${index + 1}">
                        <div class="metric-value">${count}</div>
                        <div class="metric-label">${plan} (${percentage}%)</div>
                    </div>
                `;
            }).join('');
        }

        function renderOperationTrendChart() {
            const ctx = document.getElementById('operationTrendChart');
            if (!ctx) return;

            if (charts.operationTrend) {
                charts.operationTrend.destroy();
            }

            // Group operations by exact value from column K and day (for filtered data)
            const operationData = {};
            
            filteredDashboardData.forEach(patient => {
                if (patient.Date && patient.Operation) {
                    try {
                        const date = new Date(patient.Date);
                        const dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        
                        // Get exact operation value from column K (Operation)
                        let operationType = patient.Operation.trim();
                        
                        // If operation name is too long, truncate it for display
                        if (operationType.length > 30) {
                            operationType = operationType.substring(0, 30) + '...';
                        }
                        
                        // If empty, set as 'ไม่ระบุ'
                        if (!operationType || operationType === '') {
                            operationType = 'ไม่ระบุ';
                        }
                        
                        if (!operationData[operationType]) {
                            operationData[operationType] = {};
                        }
                        if (!operationData[operationType][dayKey]) {
                            operationData[operationType][dayKey] = 0;
                        }
                        operationData[operationType][dayKey]++;
                    } catch (error) {
                        // Skip invalid dates
                    }
                }
            });

            // Get top 15 operation types by total count (increased from 10)
            const operationTotals = {};
            Object.keys(operationData).forEach(opType => {
                operationTotals[opType] = Object.values(operationData[opType]).reduce((sum, count) => sum + count, 0);
            });
            
            const topOperations = Object.keys(operationTotals)
                .sort((a, b) => operationTotals[b] - operationTotals[a])
                .slice(0, 15);

            const allDays = [...new Set(
                filteredDashboardData
                    .filter(p => p.Date)
                    .map(p => {
                        try {
                            const date = new Date(p.Date);
                            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                        } catch {
                            return null;
                        }
                    })
                    .filter(d => d)
            )].sort();

            // Format day labels for display (DD/MM)
            const dayLabels = allDays.map(dayKey => {
                const [year, month, day] = dayKey.split('-');
                return `${day}/${month}`;
            });

            // Enhanced color palette with more distinct and vibrant colors
            const colors = [
                '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', 
                '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E9',
                '#F8C471', '#82E0AA', '#F1948A', '#85C1E9', '#D7BDE2',
                '#A9DFBF', '#F9E79F', '#D5A6BD', '#AED6F1', '#A3E4D7'
            ];

            const datasets = topOperations.map((operation, index) => ({
                label: operation,
                data: allDays.map(day => operationData[operation]?.[day] || 0),
                borderColor: colors[index % colors.length],
                backgroundColor: colors[index % colors.length] + '40',
                tension: 0.4,
                fill: true,
                pointRadius: 5,
                pointHoverRadius: 8,
                borderWidth: 4,
                pointBackgroundColor: colors[index % colors.length],
                pointBorderColor: '#FFFFFF',
                pointBorderWidth: 3,
                shadowOffsetX: 2,
                shadowOffsetY: 2,
                shadowBlur: 6,
                shadowColor: 'rgba(0,0,0,0.2)'
            }));

            charts.operationTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dayLabels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                boxWidth: 15,
                                padding: 10,
                                font: {
                                    size: 12,
                                    weight: '500'
                                },
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        title: {
                            display: true,
                            text: 'แนวโน้มการผ่าตัดรายวัน (แยกตามประเภท) - Top 15',
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            color: '#2D3748'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                maxTicksLimit: 15,
                                font: {
                                    size: 11
                                }
                            },
                            grid: {
                                color: 'rgba(0,0,0,0.05)'
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });
        }

        function renderStatsTable() {
            const tbody = document.getElementById('statsTableBody');
            if (!tbody) return;

            // Complete list of categories in the requested order
            const categories = [
                'Pre ward', 'Sex', 'AN type', 'AN type 2', 'Service', 'Dx.', 'Operation', 'Plan ICU', 
                'การเยี่ยมผู้ป่วย', 'Aware 1', 'Aware 2', 'Aware 3', 'IC', 'CVS', 'Endo', 'RS', 
                'Hemato', 'Other', 'Stroke Risk', 'Cardiac Risk', 'Malampati', 'IIG', 'MH distance', 
                'MT distance', 'MSD', 'AOJ extention', 'ASA status', 'NPO', 'รอดมยา', 
                'Aldrette score แรกรับ', 'Anesthesia', 'Tube', 'LV', 'Attempt', 'AN time', 'Start-go', 
                'Intra comp', 'Pre Hct', 'G/M blood', 'G/M FFP', 'G/M Plt Conc', 'OR G/M', 'PRC/LPRC', 
                'FFP', 'Plt Conc', 'Intra EBL', 'RR comp 1', 'RR comp 2', 'RR EBL', 
                'Aldrette scoreก่อนกลับตึก', 'RR time', 'Ward comp 1', 'Post ward', 'Pre op pain', 
                'pain สูงสุด', 'Last pain', 'Narcotic', 'Total narcotic (ครั้ง)', 'NSAIDS', 'PO pain Rx.', 
                'PO guideline', 'Pre an visit', 'Anesthetist 1', 'Anesthetist 2', 'Anesthetist 3', 
                'Anesthetist 4', 'RR nurse 1', 'RR nurse 2', 'RR nurse 3', 'Post an visit', 
                'Surgeon 1', 'Surgeon 2'
            ];

            let tableRows = [];
            const total = filteredDashboardData.length;

            if (total === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" style="text-align: center; padding: 20px; color: #64748B;">
                            ไม่พบข้อมูลสำหรับสร้างตารางสถิติ
                        </td>
                    </tr>
                `;
                return;
            }

            categories.forEach(category => {
                const counts = {};
                let hasData = false;
                
                filteredDashboardData.forEach(patient => {
                    let value = patient[category];
                    
                    // Handle different data types
                    if (value === null || value === undefined || value === '') {
                        value = 'ไม่ระบุ';
                    } else {
                        hasData = true;
                        if (typeof value === 'string') {
                            value = value.trim();
                            if (value === '') {
                                value = 'ไม่ระบุ';
                            }
                        } else if (typeof value === 'number') {
                            value = value.toString();
                        } else {
                            value = String(value);
                        }
                    }
                    
                    counts[value] = (counts[value] || 0) + 1;
                });

                // Only show categories that have some data (not all "ไม่ระบุ")
                if (hasData || Object.keys(counts).length > 1 || (Object.keys(counts).length === 1 && !Object.keys(counts).includes('ไม่ระบุ'))) {
                    // Get top 5 items for each category, but show all if less than 5
                    const sortedEntries = Object.entries(counts)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 5);

                    sortedEntries.forEach(([item, count]) => {
                        const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : 0;
                        tableRows.push({
                            category,
                            item: item.length > 40 ? item.substring(0, 40) + '...' : item, // Truncate long items
                            count,
                            percentage
                        });
                    });
                }
            });

            // Group by category for better display
            let currentCategory = '';
            const groupedRows = tableRows.map(row => {
                const isNewCategory = row.category !== currentCategory;
                currentCategory = row.category;
                
                return `
                    <tr>
                        <td ${isNewCategory ? `style="font-weight: 600; background: rgba(110, 231, 183, 0.1); border-left: 3px solid #10B981;"` : ''}>${isNewCategory ? row.category : ''}</td>
                        <td>${row.item}</td>
                        <td style="text-align: center; font-weight: 500;">${row.count}</td>
                        <td style="text-align: center; padding: 8px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="flex: 1; background: #F1F5F9; border-radius: 10px; height: 20px; position: relative; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); min-width: 80px;">
                                    <div style="
                                        width: ${row.percentage}%; 
                                        height: 100%; 
                                        background: linear-gradient(135deg, #10B981 0%, #34D399 100%); 
                                        border-radius: 10px; 
                                        transition: all 0.3s ease;
                                        box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
                                        position: relative;
                                    ">
                                        <div style="
                                            position: absolute;
                                            top: 0;
                                            left: 0;
                                            right: 0;
                                            height: 50%;
                                            background: linear-gradient(to bottom, rgba(255,255,255,0.4) 0%, transparent 100%);
                                            border-radius: 10px 10px 0 0;
                                        "></div>
                                    </div>
                                </div>
                                <span style="font-weight: 600; color: #059669; min-width: 45px; font-size: 13px;">${row.percentage}%</span>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = groupedRows.join('');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.querySelector('input[name="Date"]');
            if (dateInput) {
                dateInput.value = today;
            }

            // Initialize column settings
            initializeColumnSettings();
            
            // Generate dynamic form based on settings
            generateDynamicForm();
            
            // Update ward filter options
            updateWardFilterOptions();

            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('detailModal');
                if (event.target === modal) {
                    closeModal();
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9866ff1f11fc33b6',t:'MTc1OTEwMTg5MS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
